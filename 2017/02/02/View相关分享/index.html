<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Android View
Android View框架相关  View的测量 布局 绘制过程LinearLayout RelativeLayout实现源码分析

从setContentView与LayoutInflater说起setContentView分析相关关系  
  Activity中有Window成员 实例化为PhoneWindow PhoneWindow是抽象Window类的实现类">
<meta property="og:type" content="article">
<meta property="og:title" content="View相关分享">
<meta property="og:url" content="http://clwater.github.io/2017/02/02/View相关分享/index.html">
<meta property="og:site_name" content="Clwater Blog">
<meta property="og:description" content="Android View
Android View框架相关  View的测量 布局 绘制过程LinearLayout RelativeLayout实现源码分析

从setContentView与LayoutInflater说起setContentView分析相关关系  
  Activity中有Window成员 实例化为PhoneWindow PhoneWindow是抽象Window类的实现类">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/2191286-ed8a7074cddfb63c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://clwater.github.io/View层级分析.png">
<meta property="og:image" content="http://clwater.github.io/inflate参数.png">
<meta property="og:image" content="http://clwater.github.io/View.png">
<meta property="og:image" content="http://clwater.github.io/View measure过程.png">
<meta property="og:image" content="http://clwater.github.io/View draw流程.png">
<meta property="og:image" content="http://clwater.github.io/LinearLayout二次测量.png">
<meta property="og:image" content="http://clwater.github.io/负delta.png">
<meta property="og:updated_time" content="2017-02-02T15:30:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="View相关分享">
<meta name="twitter:description" content="Android View
Android View框架相关  View的测量 布局 绘制过程LinearLayout RelativeLayout实现源码分析

从setContentView与LayoutInflater说起setContentView分析相关关系  
  Activity中有Window成员 实例化为PhoneWindow PhoneWindow是抽象Window类的实现类">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/2191286-ed8a7074cddfb63c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://clwater.github.io/2017/02/02/View相关分享/"/>





  <title> View相关分享 | Clwater Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Clwater Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">日常写bug</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Accueil
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://clwater.github.io/2017/02/02/View相关分享/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="clwater">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/myimage.jpeg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Clwater Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Clwater Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                View相关分享
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posté le</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-02T23:25:57+08:00">
                2017-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Android-View"><a href="#Android-View" class="headerlink" title="Android View"></a>Android View</h1><blockquote>
<p>Android View框架相关  View的测量 布局 绘制过程<br>LinearLayout RelativeLayout实现源码分析</p>
</blockquote>
<h2 id="从setContentView与LayoutInflater说起"><a href="#从setContentView与LayoutInflater说起" class="headerlink" title="从setContentView与LayoutInflater说起"></a>从setContentView与LayoutInflater说起</h2><h3 id="setContentView分析"><a href="#setContentView分析" class="headerlink" title="setContentView分析"></a>setContentView分析</h3><h4 id="相关关系"><a href="#相关关系" class="headerlink" title="相关关系"></a>相关关系</h4><p>  <img src="http://upload-images.jianshu.io/upload_images/2191286-ed8a7074cddfb63c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="相关关系图"></p>
<p>  Activity中有Window成员 实例化为PhoneWindow PhoneWindow是抽象Window类的实现类</p>
<p>  Window提供了绘制窗口的通用API PhoneWindow中包含了DecorView对象 是所有窗口(Activity界面)的根View</p>
<p>  具体的构如下</p>
<p>  <img src="/View层级分析.png" alt="View层级分析"></p>
<p>  通过hierarchyviewer工具分析一下</p>
<h4 id="PhoneWindow的setContentView分析"><a href="#PhoneWindow的setContentView分析" class="headerlink" title="PhoneWindow的setContentView分析"></a>PhoneWindow的setContentView分析</h4><blockquote>
<p>Window类的setContentView方法 而Window的setContentView方法是抽象的  所以查看PhoneWindow的setContentView()</p>
</blockquote>
<ol>
<li><p>setContentView方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is the view in which the window contents are placed. It is either</span></div><div class="line"><span class="comment">// mDecor itself, or a child of mDecor where the contents go.</span></div><div class="line"><span class="keyword">private</span> ViewGroup mContentParent;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line">    <span class="comment">// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span></div><div class="line">    <span class="comment">// decor, when theme attributes and the like are crystalized. Do not check the feature</span></div><div class="line">    <span class="comment">// before this happens.</span></div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//第一次调用</span></div><div class="line">        <span class="comment">//下面会详细分析</span></div><div class="line">        installDecor();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        <span class="comment">//移除该mContentParent下的所有View</span></div><div class="line">        <span class="comment">//又因为这个的存在  我们可以多次使用setContentView()</span></div><div class="line">        mContentParent.removeAllViews();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//判断是否使用了Activity的过度动画</span></div><div class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">      <span class="comment">//设置动画场景</span></div><div class="line">        <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</div><div class="line">                getContext());</div><div class="line">        transitionTo(newScene);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//将资源文件通过LayoutInflater对象装换为View树</span></div><div class="line">        <span class="comment">//在PhoneWindow的构造函数中 mLayoutInflater = LayoutInflater.from(context);</span></div><div class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//View中</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Ask that a new dispatch of &#123;<span class="doctag">@link</span> #onApplyWindowInsets(WindowInsets)&#125; be performed.</div><div class="line">     */</div><div class="line">    <span class="comment">// public void requestApplyInsets() &#123;</span></div><div class="line">    <span class="comment">//     requestFitSystemWindows();</span></div><div class="line">    <span class="comment">// &#125;</span></div><div class="line">    mContentParent.requestApplyInsets();</div><div class="line">    <span class="keyword">final</span> Callback cb = getCallback();</div><div class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</div><div class="line">        cb.onContentChanged();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    setContentView(view, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        installDecor();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        mContentParent.removeAllViews();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        view.setLayoutParams(params);</div><div class="line">        <span class="keyword">final</span> Scene newScene = <span class="keyword">new</span> Scene(mContentParent, view);</div><div class="line">        transitionTo(newScene);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//已经为View 直接使用View的addView方法追加到当前mContentParent中</span></div><div class="line">        mContentParent.addView(view, params);</div><div class="line">    &#125;</div><div class="line">    mContentParent.requestApplyInsets();</div><div class="line">    <span class="keyword">final</span> Callback cb = getCallback();</div><div class="line">    <span class="comment">//调用CallBack接口的onContentChange来通知Activity组件视图发生了变化</span></div><div class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</div><div class="line">        cb.onContentChanged();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>installDecor方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//截取部分主要分析代码</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//如果mDecor为空则创建一个DecorView实例</span></div><div class="line">        <span class="comment">// protected DecorView generateDecor() &#123;</span></div><div class="line">        <span class="comment">//   return new DecorView(getContext(), -1);</span></div><div class="line">        <span class="comment">// &#125;</span></div><div class="line">        mDecor = generateDecor();</div><div class="line">        mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</div><div class="line">        mDecor.setIsRootNamespace(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="number">0</span>) &#123;</div><div class="line">            mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//根据窗口的风格修饰 选择对应的修饰布局文件 将id为content的FrameLayout赋值于mContentParent</span></div><div class="line">        mContentParent = generateLayout(mDecor);</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</div><div class="line">     <span class="comment">// Apply data from current theme.</span></div><div class="line">     <span class="comment">//根据当前style修饰相应样式</span></div><div class="line"></div><div class="line">     TypedArray a = getWindowStyle();</div><div class="line"></div><div class="line">     ...</div><div class="line">     <span class="comment">//一堆if判断</span></div><div class="line"></div><div class="line">     <span class="comment">// 增加窗口修饰</span></div><div class="line"></div><div class="line">     <span class="keyword">int</span> layoutResource;</div><div class="line">     <span class="keyword">int</span> features = getLocalFeatures();</div><div class="line"></div><div class="line">     ...</div><div class="line">     <span class="comment">//根据features选择不同的窗帘修饰布局文件得到</span></div><div class="line">     <span class="comment">//把选中的窗口修饰布局文件添加到DecorView中, 指定contentParent的值</span></div><div class="line">     View in = mLayoutInflater.inflate(layoutResource, <span class="keyword">null</span>);</div><div class="line">     decor.addView(in, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">     mContentRoot = (ViewGroup) in;</div><div class="line"></div><div class="line">     ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</div><div class="line">     <span class="keyword">if</span> (contentParent == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Window couldn't find content container view"</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     ...</div><div class="line">     <span class="keyword">return</span> contentParent;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>该方法的主要功能为 根据窗口的style为该窗口选择不同的窗口根布局文件 将mDecor作为根视图将窗口布局添加,获取id为content的FrameLayout返回给mContentParent对象  实质为阐释mDecor和mContentParent对象</p>
</li>
<li><p>(扩展)关于设置Activity属性需要在setContentView方法之前调用的问题</p>
<p>在设置Activity属性的时候 比如requestWindowFeature(Window.FEATURE_NO_TITLE) 需要在setContentView方法之前调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">requestFeature</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mContentParent != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(<span class="string">"requestFeature() must be called before adding content"</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>onContentChanged方法</p>
<p>在PhoneWindow中没有重写getCallback相关方法 而在Window类下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Return the current Callback interface for this window.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Callback <span class="title">getCallback</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mCallback;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mCallback相关的赋值方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Set the Callback interface for this window, used to intercept key</div><div class="line"> * events and other dynamic operations in the window.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> callback The desired Callback interface.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(Callback callback)</span> </span>&#123;</div><div class="line">    mCallback = callback;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>setCallback方法在Activity中被使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></div><div class="line">          Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</div><div class="line">          Application application, Intent intent, ActivityInfo info,</div><div class="line">          CharSequence title, Activity parent, String id,</div><div class="line">          NonConfigurationInstances lastNonConfigurationInstances,</div><div class="line">          Configuration config, String referrer, IVoiceInteractor voiceInteractor) &#123;</div><div class="line">      ...</div><div class="line">      mWindow.setCallback(<span class="keyword">this</span>);</div><div class="line">      ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>说明Activity实现了Window的CallBack接口 然后在Activity中找到onContentChanged方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContentChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对 空方法. 说明在Activity的布局改动时 (setContentView或者addContentView 方法执行完毕后会调用改方法)<br>所以各种View的findViewById方法什么的可以放在这里</p>
</li>
<li><p>setContentView源码总结</p>
<ul>
<li>创建一个DecorView的对象mDector 该mDector将作为整个应用窗口的根视图</li>
<li>根据根据Feature等style theme创建不同的窗口修饰布局文件 并且通过findViewById获取Activity布局文件该存放的地方</li>
<li>将Activity的布局文件添加至id为content的FrameLayout内</li>
<li>执行到当前页面还没有显示出来</li>
</ul>
</li>
<li><p>Activity页面显示</p>
<p>我们都知道Activity的实际开始于ActivityThread的main方法 当该方法调运完之后会调用该类的performLaunchActivity方法来创建要启动的Activity组件 这个过程中还会为该Activity组件创建窗口对象和视图对象 当组件创建完成后用过调用该类的handleResumeActivity方法将其激活</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></div><div class="line">           <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume) &#123;</div><div class="line">             ...</div><div class="line">           <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible</div><div class="line">                   &amp;&amp; r.activity.mDecor != <span class="keyword">null</span> &amp;&amp; !r.hideForNow) &#123;</div><div class="line">               ...</div><div class="line">               <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</div><div class="line">                   r.activity.makeVisible();</div><div class="line">                   <span class="comment">//这里这里 通过调用Activity的makeVisible方法来显示我们通过setContentView创建的mDecor</span></div><div class="line">               &#125;</div><div class="line">               ...</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">         ...</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Activity的makeVisible方法</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeVisible</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (!mWindowAdded) &#123;</div><div class="line">         ViewManager wm = getWindowManager();</div><div class="line">         wm.addView(mDecor, getWindow().getAttributes());</div><div class="line">         mWindowAdded = <span class="keyword">true</span>;</div><div class="line">     &#125;</div><div class="line">     mDecor.setVisibility(View.VISIBLE);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>至此通过setContentView方法设置的页面才最后显示出来</p>
</li>
</ol>
<h3 id="LayoutInflater源码分析"><a href="#LayoutInflater源码分析" class="headerlink" title="LayoutInflater源码分析"></a>LayoutInflater源码分析</h3><ol>
<li><p>与setContentView相关</p>
<p>在PhoneWindow的generateLayout中调用了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">View in = mLayoutInflater.inflate(layoutResource, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>LayoutInflater中获取实例化方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Obtains the LayoutInflater from the given context.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LayoutInflater <span class="title">from</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    LayoutInflater LayoutInflater =</div><div class="line">            (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">    <span class="keyword">if</span> (LayoutInflater == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LayoutInflater not found."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> LayoutInflater;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>inflate方法相关</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(@LayoutRes <span class="keyword">int</span> resource, @Nullable ViewGroup root)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> inflate(resource, root, root != <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(XmlPullParser parser, @Nullable ViewGroup root)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> inflate(parser, root, root != <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(@LayoutRes <span class="keyword">int</span> resource, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Resources res = getContext().getResources();</div><div class="line">    <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"INFLATING from resource: \""</span> + res.getResourceName(resource) + <span class="string">"\" ("</span></div><div class="line">                + Integer.toHexString(resource) + <span class="string">")"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> XmlResourceParser parser = res.getLayout(resource);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> inflate(parser, root, attachToRoot);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        parser.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后发现都需要调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(XmlPullParser parser, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mConstructorArgs) &#123;</div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"inflate"</span>);</div><div class="line"></div><div class="line">            <span class="keyword">final</span> Context inflaterContext = mContext;</div><div class="line">            <span class="keyword">final</span> AttributeSet attrs = Xml.asAttributeSet(parser);</div><div class="line">            Context lastContext = (Context) mConstructorArgs[<span class="number">0</span>];</div><div class="line">            mConstructorArgs[<span class="number">0</span>] = inflaterContext;</div><div class="line">            <span class="comment">//定义返回值 初始化传入形参 root</span></div><div class="line">            View result = root;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 找到根节点</span></div><div class="line">                <span class="keyword">int</span> type;</div><div class="line">                <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</div><div class="line">                        type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//验证type是否为Start_Tag  保证xml文件正确</span></div><div class="line">                <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(parser.getPositionDescription()</div><div class="line">                            + <span class="string">": No start tag found!"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//type为 root node</span></div><div class="line">                <span class="keyword">final</span> String name = parser.getName();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">                    System.out.println(<span class="string">"**************************"</span>);</div><div class="line">                    System.out.println(<span class="string">"Creating root view: "</span></div><div class="line">                            + name);</div><div class="line">                    System.out.println(<span class="string">"**************************"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</div><div class="line">                    <span class="comment">//处理 merge相关</span></div><div class="line">                    <span class="comment">//root需要非空 且attachToRoot为空</span></div><div class="line">                    <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; can be used only with a valid "</span></div><div class="line">                                + <span class="string">"ViewGroup root and attachToRoot=true"</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//递归inflate 方法调用</span></div><div class="line">                    rInflate(parser, root, inflaterContext, attrs, <span class="keyword">false</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">//根据tag节点创建view对象</span></div><div class="line">                    <span class="keyword">final</span> View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line"></div><div class="line">                    ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">                            System.out.println(<span class="string">"Creating params from root: "</span> +</div><div class="line">                                    root);</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//根据root生成LayoutParams</span></div><div class="line">                        params = root.generateLayoutParams(attrs);</div><div class="line">                        <span class="keyword">if</span> (!attachToRoot) &#123;</div><div class="line">                            <span class="comment">//如果attachToRoot为flase 则调用setLayoutParams</span></div><div class="line">                            temp.setLayoutParams(params);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">                        System.out.println(<span class="string">"-----&gt; start inflating children"</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//递归inflate剩下的children</span></div><div class="line">                    rInflateChildren(parser, temp, attrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">                        System.out.println(<span class="string">"-----&gt; done inflating children"</span>);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// We are supposed to attach all the views we found (int temp)</span></div><div class="line">                    <span class="comment">// to root. Do that now.</span></div><div class="line">                    <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</div><div class="line">                        <span class="comment">//root非空且attachToRoot=true则将xml文件的root view加到形参提供的root里</span></div><div class="line">                        root.addView(temp, params);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// Decide whether to return the root that was passed in or the</span></div><div class="line">                    <span class="comment">// top view found in xml.</span></div><div class="line">                    <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                        <span class="comment">//返回xml里解析的root view</span></div><div class="line">                        result = temp;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</div><div class="line">                InflateException ex = <span class="keyword">new</span> InflateException(e.getMessage());</div><div class="line">                ex.initCause(e);</div><div class="line">                <span class="keyword">throw</span> ex;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                InflateException ex = <span class="keyword">new</span> InflateException(</div><div class="line">                        parser.getPositionDescription()</div><div class="line">                                + <span class="string">": "</span> + e.getMessage());</div><div class="line">                ex.initCause(e);</div><div class="line">                <span class="keyword">throw</span> ex;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="comment">// Don't retain static reference on context.</span></div><div class="line">                mConstructorArgs[<span class="number">0</span>] = lastContext;</div><div class="line">                mConstructorArgs[<span class="number">1</span>] = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">            <span class="comment">//返回参数root或xml文件里的root view</span></div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>相关inflate参数的结果<br><img src="/inflate参数.png" alt="inflate参数.png"></p>
</li>
<li><p>相关方法解析<br>在Inflate中多次被调用的rInflate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rInflate</span><span class="params">(XmlPullParser parser, View parent, Context context,</span></span></div><div class="line">        AttributeSet attrs, <span class="keyword">boolean</span> finishInflate) <span class="keyword">throws</span> XmlPullParserException, IOException &#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> depth = parser.getDepth();</div><div class="line">    <span class="keyword">int</span> type;</div><div class="line">    <span class="comment">//XmlPullParser解析器的标准解析模式</span></div><div class="line">    <span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG ||</div><div class="line">            parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">        <span class="comment">//找到start_tag节点</span></div><div class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//获取Name标记</span></div><div class="line">        <span class="keyword">final</span> String name = parser.getName();</div><div class="line"></div><div class="line">        <span class="comment">//private static final String TAG_REQUEST_FOCUS = "requestFocus";</span></div><div class="line">        <span class="comment">//处理requestFocus</span></div><div class="line">        <span class="keyword">if</span> (TAG_REQUEST_FOCUS.equals(name)) &#123;</div><div class="line">            parseRequestFocus(parser, parent);</div><div class="line">        <span class="comment">// private static final String TAG_TAG = "tag";</span></div><div class="line">        <span class="comment">//处理tag</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_TAG.equals(name)) &#123;</div><div class="line">            parseViewTag(parser, parent, attrs);</div><div class="line">        <span class="comment">//private static final String TAG_INCLUDE = "include";</span></div><div class="line">        <span class="comment">//处理include</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_INCLUDE.equals(name)) &#123;</div><div class="line">            <span class="comment">//如果是根节点则抛出异常</span></div><div class="line">            <span class="keyword">if</span> (parser.getDepth() == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;include /&gt; cannot be the root element"</span>);</div><div class="line">            &#125;</div><div class="line">            parseInclude(parser, context, parent, attrs);</div><div class="line">        <span class="comment">//private static final String TAG_MERGE = "merge";</span></div><div class="line">        <span class="comment">//处理merge merge需要是xml中的根节点</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; must be the root element"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">final</span> View view = createViewFromTag(parent, name, context, attrs);</div><div class="line">            <span class="keyword">final</span> ViewGroup viewGroup = (ViewGroup) parent;</div><div class="line">            <span class="keyword">final</span> ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</div><div class="line">            rInflateChildren(parser, view, attrs, <span class="keyword">true</span>);</div><div class="line">            viewGroup.addView(view, params);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     <span class="comment">//parent的所有子节点都处理完毕的时候回onFinishInflate方法</span></div><div class="line">    <span class="keyword">if</span> (finishInflate) &#123;</div><div class="line">        parent.onFinishInflate();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//可以添加自定义逻辑</span></div><div class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="View的测量-布局-绘制过程"><a href="#View的测量-布局-绘制过程" class="headerlink" title="View的测量 布局 绘制过程"></a>View的测量 布局 绘制过程</h2><h3 id="测量之前的事情"><a href="#测量之前的事情" class="headerlink" title="测量之前的事情"></a>测量之前的事情</h3><p>View的整个绘制流程是开始于ViewRootImpl类的performTraversals方法(1k行)  根据相关设置来觉得十分要重新执行相关功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// cache mView since it is used so much below...</span></div><div class="line">  <span class="keyword">final</span> View host = mView;</div><div class="line">  ...</div><div class="line">  <span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</div><div class="line">  <span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</div><div class="line">  ...</div><div class="line">  <span class="comment">//measure</span></div><div class="line">  mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">  ...</div><div class="line">  <span class="comment">//layout</span></div><div class="line">  mView.layout(<span class="number">0</span>, <span class="number">0</span>, mView.getMeasuredWidth(), mView.getMeasuredHeight());</div><div class="line">  ...</div><div class="line">  <span class="comment">//draw</span></div><div class="line">  mView.draw(canvas);</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span> rootDimension)</span> </span>&#123;</div><div class="line">      <span class="keyword">int</span> measureSpec;</div><div class="line">      <span class="keyword">switch</span> (rootDimension) &#123;</div><div class="line"></div><div class="line">      <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:</div><div class="line">          <span class="comment">// Window can't resize. Force root view to be windowSize.</span></div><div class="line">          measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      ...</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> measureSpec;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>View measure整体流程图如下</p>
<p><img src="/View.png" alt="View绘制整体流程图"></p>
<h3 id="measure源码分析"><a href="#measure源码分析" class="headerlink" title="measure源码分析"></a>measure源码分析</h3><p>结论:</p>
<ul>
<li><p>measure的过程就是父View向子View递归调用view.measure方法 (measure中回调onMeasure方法)的过程</p>
</li>
<li><p>measure方法是 final的 只能重载onMeasure方法</p>
</li>
<li><p>最顶层的DocerView的MeasureSpec由ViewRootImpl的getRootMeasureSpec方法提供 LayoutParams的参数为MATCH_PARENT specMode是EXACTLY，specSize为物理屏幕大小</p>
</li>
<li><p>只要是ViewGroup的子类就必须要求LayoutParams继承子MarginLayoutParams 否则无法使用layout_margin参数</p>
</li>
<li><p>View的getMeasuredWidth()和getMeasuredHeight()方法来获取View测量的宽高，要必须保证这两个方法在onMeasure流程之后被调用才能返回有效值。</p>
</li>
</ul>
<p><img src="/View measure过程.png" alt="View measure过程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * This is called to find out how big a view should be. The parent supplies constraint information in the width and height parameters.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The actual measurement work of a view is performed in</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line"> *        parent</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #onMeasure(int, int)</div><div class="line"> */</div><div class="line"> <span class="comment">//没舍得删这些注释  感觉重要的事情都说了   为了计算整个View树的实际大小 设置实际的高和宽 每个子View都是根据父视图和自身决定实际宽高的 在onMeasure()方法中进行实际测量.传入widthMeasureSpec和heightMeasureSpec参数来表示了父View的规格 不但传入了模式 还传入了size 而对于DecorView来说 传入的模式一般为EXACTLY模式 size对应屏幕的宽高. 所以说子View的大小是父子View共同决定的</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line"></div><div class="line">               <span class="comment">// measure ourselves, this should set the measured dimension flag back</span></div><div class="line">               onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>MeasureSpec内部类</p>
<p>MeasureSpec是View的内部类 int型，由高2位规格模式specMode和低30位具体尺寸specSize组成 其中specMode只有三种</p>
<ul>
<li>MeasureSpec.EXACTLY //确定模式，父View希望子View的大小是确定的，由specSize决定；</li>
<li>MeasureSpec.AT_MOST //最多模式，父View希望子View的大小最多是specSize指定的值；</li>
<li>MeasureSpec.UNSPECIFIED //未指定模式，父View完全依据子View的设计值来决定；</li>
</ul>
<p>onMeasure()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &lt;p&gt;</div><div class="line"> * Measure the view and its content to determine the measured width and the</div><div class="line"> * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line"> * should be overridden by subclasses to provide accurate and efficient</div><div class="line"> * measurement of their contents.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line"> * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line"> * measured width and height of this view. Failure to do so will trigger an</div><div class="line"> * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line"> * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line"> * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The base class implementation of measure defaults to the background size,</div><div class="line"> * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line"> * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line"> * their content.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is overridden, it is the subclass's responsibility to make</div><div class="line"> * sure the measured height and width are at least the view's minimum height</div><div class="line"> * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line"> * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;<span class="doctag">@link</span> android.view.View.MeasureSpec&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredWidth()</div><div class="line"> * <span class="doctag">@see</span> #getMeasuredHeight()</div><div class="line"> * <span class="doctag">@see</span> #setMeasuredDimension(int, int)</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumHeight()</div><div class="line"> * <span class="doctag">@see</span> #getSuggestedMinimumWidth()</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getMode(int)</div><div class="line"> * <span class="doctag">@see</span> android.view.View.MeasureSpec#getSize(int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getDefaultSize方法相关<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> result = size;</div><div class="line">  <span class="comment">//通过measureSpec得到mode和size</span></div><div class="line">  <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">  <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">  <span class="keyword">switch</span> (specMode) &#123;</div><div class="line">  <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">      result = size;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  <span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">  <span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">      result = specSize;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//最小宽度和高度由View的Background尺寸和View的minXXX共同决定</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinHeight : max(mMinHeight, mBackground.getMinimumHeight());</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>setMeasuredDimension方法 对View的成员变量measuredWidth和measuredHeight变量赋值 也就是说该方法最终决定了View的大小<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">        Insets insets = getOpticalInsets();</div><div class="line">        <span class="keyword">int</span> opticalWidth  = insets.left + insets.right;</div><div class="line">        <span class="keyword">int</span> opticalHeight = insets.top  + insets.bottom;</div><div class="line"></div><div class="line">        measuredWidth  += optical ? opticalWidth  : -opticalWidth;</div><div class="line">        measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">    &#125;</div><div class="line">    setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLayoutRequested</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">  mMeasuredWidth = measuredWidth;</div><div class="line">  mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">  mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>至此一次最基础的View的measure过程就完成了  但是由于View可以嵌套  所以measure是递归传递的所以ViewGroup中需要对其子类进行measure过程 measureChildren方法实质为循环调用measureChild方法</p>
<p>而measureChild和measureChildWithMargins的区别是后者将margin和padding也作为了子视图的大小</p>
<p>一下分析measureChildWithMargins方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></div><div class="line">        <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</div><div class="line">        <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed) &#123;</div><div class="line">    <span class="comment">//获取当前子视图的LayoutParams</span></div><div class="line">    <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line">    <span class="comment">//设定子View的测量规格</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</div><div class="line">                    + widthUsed, lp.width);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</div><div class="line">                    + heightUsed, lp.height);</div><div class="line">    <span class="comment">//子view的继续调用</span></div><div class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//在getChildMeasureSpec中通过父View和本身的模式共同决定当前View的size</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</div><div class="line">      <span class="comment">//获取当前父View的mode和size</span></div><div class="line">      <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);</div><div class="line">      <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);</div><div class="line">      <span class="comment">//获取父View的的剩余大小</span></div><div class="line">      <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</div><div class="line">      <span class="comment">//定义结果变量</span></div><div class="line">      <span class="keyword">int</span> resultSize = <span class="number">0</span>;</div><div class="line">      <span class="keyword">int</span> resultMode = <span class="number">0</span>;</div><div class="line">      <span class="comment">//根据对应的mode做处理</span></div><div class="line">      <span class="comment">//通过父View和本身的模式共同决定当前View的size</span></div><div class="line">      <span class="keyword">switch</span> (specMode) &#123;</div><div class="line">      <span class="comment">// Parent has imposed an exact size on us</span></div><div class="line">      <span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">          <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</div><div class="line">              resultSize = childDimension;</div><div class="line">              resultMode = MeasureSpec.EXACTLY;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">              <span class="comment">// Child wants to be our size. So be it.</span></div><div class="line">              resultSize = size;</div><div class="line">              resultMode = MeasureSpec.EXACTLY;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">              <span class="comment">// Child wants to determine its own size. It can't be</span></div><div class="line">              <span class="comment">// bigger than us.</span></div><div class="line">              resultSize = size;</div><div class="line">              resultMode = MeasureSpec.AT_MOST;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="comment">// Parent has imposed a maximum size on us</span></div><div class="line">      <span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">          <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</div><div class="line">              <span class="comment">// Child wants a specific size... so be it</span></div><div class="line">              resultSize = childDimension;</div><div class="line">              resultMode = MeasureSpec.EXACTLY;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">              <span class="comment">// Child wants to be our size, but our size is not fixed.</span></div><div class="line">              <span class="comment">// Constrain child to not be bigger than us.</span></div><div class="line">              resultSize = size;</div><div class="line">              resultMode = MeasureSpec.AT_MOST;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">              <span class="comment">// Child wants to determine its own size. It can't be</span></div><div class="line">              <span class="comment">// bigger than us.</span></div><div class="line">              resultSize = size;</div><div class="line">              resultMode = MeasureSpec.AT_MOST;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="comment">// Parent asked to see how big we want to be</span></div><div class="line">      <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">          <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</div><div class="line">              <span class="comment">// Child wants a specific size... let him have it</span></div><div class="line">              resultSize = childDimension;</div><div class="line">              resultMode = MeasureSpec.EXACTLY;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">              <span class="comment">// Child wants to be our size... find out how big it should</span></div><div class="line">              <span class="comment">// be</span></div><div class="line">              resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</div><div class="line">              resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">              <span class="comment">// Child wants to determine its own size.... find out how</span></div><div class="line">              <span class="comment">// big it should be</span></div><div class="line">              resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</div><div class="line">              resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//将size和mode整合为MeasureSpec模式后返回</span></div><div class="line">      <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h3 id="layout源码分析"><a href="#layout源码分析" class="headerlink" title="layout源码分析"></a>layout源码分析</h3><p>View layout整体流程与measure过程基本一样</p>
<p>结论:</p>
<ul>
<li>需要根据ViewGroup本身的情况讨论 LinearLayout下会更看重子View的height和width 来安排对应位置 而RelativeLayout则更加关注子View的left right top bottom值 并且优先级高于width和height 甚至在部分自定义ViewGroup中 measure可能是无用的   直接使用layout方法来设置子View的位置也可以</li>
<li>ViewGroup需要实现自己的layout逻辑</li>
<li>layout_XXX中的各个熟悉都是针对子View的父ViewGroup的</li>
<li>同样使用View的getWidth()和getHeight()方法来获取View测量的宽高 必须保证这两个方法在onLayout流程之后被调用才能返回有效值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Assign a size and position to a view and all of its</div><div class="line">   * descendants</div><div class="line">   *</div><div class="line">   * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line">   * (The first is measuring). In this phase, each parent calls</div><div class="line">   * layout on all of its children to position them.</div><div class="line">   * This is typically done using the child measurements</div><div class="line">   * that were stored in the measure pass().&lt;/p&gt;</div><div class="line">   *</div><div class="line">   * &lt;p&gt;Derived classes should not override this method.</div><div class="line">   * Derived classes with children should override</div><div class="line">   * onLayout. In that method, they should</div><div class="line">   * call layout on each of their children.&lt;/p&gt;</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> l Left position, relative to parent</div><div class="line">   * <span class="doctag">@param</span> t Top position, relative to parent</div><div class="line">   * <span class="doctag">@param</span> r Right position, relative to parent</div><div class="line">   * <span class="doctag">@param</span> b Bottom position, relative to parent</div><div class="line">   */</div><div class="line"></div><div class="line">   <span class="comment">//同样注解写的很好了  分派给他和他的所有的子视图大小和位置</span></div><div class="line">  <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</div><div class="line">          onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">          mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">      &#125;</div><div class="line">       <span class="comment">//调用setFrame方法把参数分别赋值于</span></div><div class="line">      <span class="keyword">int</span> oldL = mLeft;</div><div class="line">      <span class="keyword">int</span> oldT = mTop;</div><div class="line">      <span class="keyword">int</span> oldB = mBottom;</div><div class="line">      <span class="keyword">int</span> oldR = mRight;</div><div class="line">      <span class="comment">//判断view的位置是否发生过变化 , 确定是否对当前view重新layout</span></div><div class="line">      <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</div><div class="line">              setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line"></div><div class="line">      <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">          <span class="comment">//调用onLayout</span></div><div class="line">          onLayout(changed, l, t, r, b);</div><div class="line">          mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line">          ListenerInfo li = mListenerInfo;</div><div class="line">          <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</div><div class="line">              ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">                      (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">              <span class="keyword">int</span> numListeners = listenersCopy.size();</div><div class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">                  listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">      mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>onLyayout方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">View中</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">&#125;</div><div class="line">ViewGroup中</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,</span></span></div><div class="line">      <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b);</div></pre></td></tr></table></figure></p>
<p>均是空方法  后面会就LinearLayout和RelativeLayout源码进行分析</p>
<h3 id="draw源码分析"><a href="#draw源码分析" class="headerlink" title="draw源码分析"></a>draw源码分析</h3><p>View的draw流程图如下</p>
<p><img src="View draw流程.png" alt="Viewdraw"></p>
<p>结论:</p>
<ul>
<li>View需要在子类中实现onDraw的过程</li>
<li>在ViewGroup中 会调用其子View的方法 顺序与子view的添加顺序一致</li>
</ul>
<p>draw的源码也很长 但是官方也给出给出了draw的过程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Draw traversal performs several drawing steps which must be executed</div><div class="line">     * in the appropriate order:</div><div class="line">     *</div><div class="line">     *      1. Draw the background</div><div class="line">     *      2. If necessary, save the canvas' layers to prepare for fading</div><div class="line">     *      3. Draw view's content</div><div class="line">     *      4. Draw children</div><div class="line">     *      5. If necessary, draw the fading edges and restore layers</div><div class="line">     *      6. Draw decorations (scrollbars for instance)</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">        drawBackground(canvas);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// Step 2, save the canvas' layers</span></div><div class="line">    ...</div><div class="line">        <span class="keyword">if</span> (drawTop) &#123;</div><div class="line">            canvas.saveLayer(left, top, right, top + length, <span class="keyword">null</span>, flags);</div><div class="line">        &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// Step 3, draw the content</span></div><div class="line">    <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">    <span class="comment">// Step 4, draw the children</span></div><div class="line">    dispatchDraw(canvas);</div><div class="line"></div><div class="line">    <span class="comment">// Step 5, draw the fade effect and restore layers</span></div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (drawTop) &#123;</div><div class="line">        matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</div><div class="line">        matrix.postTranslate(left, top);</div><div class="line">        fade.setLocalMatrix(matrix);</div><div class="line">        p.setShader(fade);</div><div class="line">        canvas.drawRect(left, top, right, top + length, p);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line">    onDrawScrollBars(canvas);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Step-1-draw-the-background-if-needed"><a href="#Step-1-draw-the-background-if-needed" class="headerlink" title="Step 1, draw the background, if needed"></a>Step 1, draw the background, if needed</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Step 1, draw the background, if needed</span></div><div class="line"><span class="comment">//如果需要的话绘制背景</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">    drawBackground(canvas);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawBackground</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line"></div><div class="line">  	<span class="comment">//通过xml中属性background或者代码中setBackGroundColor\setBackgroundResource等方法赋值的背景drawable</span></div><div class="line">      <span class="keyword">final</span> Drawable background = mBackground;</div><div class="line">      <span class="keyword">if</span> (background == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">//根据layout中确定的view位置来设置背景的绘制区域</span></div><div class="line">      setBackgroundBounds();</div><div class="line"></div><div class="line"></div><div class="line">      <span class="comment">// 如果需要的话使用显示列表</span></div><div class="line">      <span class="comment">//canvas.isHardwareAccelerated() 硬件加速判定</span></div><div class="line">      <span class="comment">//硬件加速时会将图层缓存到GPU上 而不是重绘View的每一层</span></div><div class="line">      <span class="keyword">if</span> (canvas.isHardwareAccelerated() &amp;&amp; mAttachInfo != <span class="keyword">null</span></div><div class="line">              &amp;&amp; mAttachInfo.mHardwareRenderer != <span class="keyword">null</span>) &#123;</div><div class="line">          mBackgroundRenderNode = getDrawableRenderNode(background, mBackgroundRenderNode);</div><div class="line"></div><div class="line">          <span class="keyword">final</span> RenderNode renderNode = mBackgroundRenderNode;</div><div class="line">          <span class="keyword">if</span> (renderNode != <span class="keyword">null</span> &amp;&amp; renderNode.isValid()) &#123;</div><div class="line">              setBackgroundRenderNodeProperties(renderNode);</div><div class="line">              ((DisplayListCanvas) canvas).drawRenderNode(renderNode);</div><div class="line">              <span class="keyword">return</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> scrollX = mScrollX;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> scrollY = mScrollY;</div><div class="line">      <span class="comment">//调用Drawable的draw方法来完成背景的绘制工作</span></div><div class="line">      <span class="keyword">if</span> ((scrollX | scrollY) == <span class="number">0</span>) &#123;</div><div class="line">          background.draw(canvas);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          canvas.translate(scrollX, scrollY);</div><div class="line">          background.draw(canvas);</div><div class="line">          canvas.translate(-scrollX, -scrollY);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setBackgroundBounds</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (mBackgroundSizeChanged &amp;&amp; mBackground != <span class="keyword">null</span>) &#123;</div><div class="line">      mBackground.setBounds(<span class="number">0</span>, <span class="number">0</span>,  mRight - mLeft, mBottom - mTop);</div><div class="line">      mBackgroundSizeChanged = <span class="keyword">false</span>;</div><div class="line">      rebuildOutline();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Step-2-save-the-canvas’-layers"><a href="#Step-2-save-the-canvas’-layers" class="headerlink" title="Step 2, save the canvas’ layers"></a>Step 2, save the canvas’ layers</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Step 2, save the canvas' layers</span></div><div class="line"><span class="comment">//保存绘制图层</span></div><div class="line"></div><div class="line">       <span class="keyword">if</span> (drawTop) &#123;</div><div class="line">           canvas.saveLayer(left, top, right, top + length, <span class="keyword">null</span>, flags);</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<h4 id="Step-3-draw-the-content"><a href="#Step-3-draw-the-content" class="headerlink" title="Step 3, draw the content"></a>Step 3, draw the content</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Step 3, draw the content</span></div><div class="line"><span class="comment">//对View的内容进行绘制</span></div><div class="line"><span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Implement this to do your drawing.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> canvas the canvas on which the background will be drawn</div><div class="line">*/</div><div class="line"><span class="comment">//onDraw也是空方法需要子类根据自身去实现相应的</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Step-4-draw-the-children"><a href="#Step-4-draw-the-children" class="headerlink" title="Step 4, draw the children"></a>Step 4, draw the children</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Step 4, draw the children</span></div><div class="line"><span class="comment">//绘制其子View</span></div><div class="line">dispatchDraw(canvas);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called by draw to draw the child views. This may be overridden</div><div class="line"> * by derived classes to gain control just before its children are drawn</div><div class="line"> * (but after its own view has been drawn).</div><div class="line"> * <span class="doctag">@param</span> canvas the canvas on which to draw the view</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line"><span class="comment">//dispatchDraw同样空方法 与onDraw不同的是dispatchDraw在ViewGroup中被重写</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ViewGroup<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//dispatchDraw方法中根据子View的不同情况 包括但不只包括该View是否显示 是否有进入或消失动画等进行了部分的调整</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">      more |= drawChild(canvas, transientChild, drawingTime);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Step-5-draw-the-fade-effect-and-restore-layers"><a href="#Step-5-draw-the-fade-effect-and-restore-layers" class="headerlink" title="Step 5, draw the fade effect and restore layers"></a>Step 5, draw the fade effect and restore layers</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Step 5, draw the fade effect and restore layers</span></div><div class="line"><span class="comment">//绘制过度效果和恢复图层</span></div><div class="line"><span class="keyword">if</span> (drawTop) &#123;</div><div class="line">    matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</div><div class="line">    matrix.postTranslate(left, top);</div><div class="line">    fade.setLocalMatrix(matrix);</div><div class="line">    p.setShader(fade);</div><div class="line">    canvas.drawRect(left, top, right, top + length, p);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Step-6-draw-decorations-scrollbars"><a href="#Step-6-draw-decorations-scrollbars" class="headerlink" title="Step 6, draw decorations (scrollbars)"></a>Step 6, draw decorations (scrollbars)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Step 6, draw decorations (scrollbars)</span></div><div class="line"><span class="comment">//对滚动条进行绘制</span></div><div class="line">onDrawScrollBars(canvas);</div></pre></td></tr></table></figure>
<h2 id="LinearLayout-源码分析"><a href="#LinearLayout-源码分析" class="headerlink" title="LinearLayout 源码分析"></a>LinearLayout 源码分析</h2><h3 id="measure过程"><a href="#measure过程" class="headerlink" title="measure过程"></a>measure过程</h3><h4 id="主要过程"><a href="#主要过程" class="headerlink" title="主要过程"></a>主要过程</h4><ul>
<li>根据布局方向选择measure过程分支</li>
<li>初始化相关变量</li>
<li>对View进行第一次测量</li>
<li>mTotalLength的再次测量</li>
<li>二次测量部分View和对为测量的子View进行测量</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="comment">//判断布局方向</span></div><div class="line">    <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;</div><div class="line">        measureVertical(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        measureHorizontal(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>measureVertical和measureHorizontal只是布局方向上的区别 以下主要分析measureVertical方法</p>
<h4 id="初始化相关变量"><a href="#初始化相关变量" class="headerlink" title="初始化相关变量"></a>初始化相关变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//mTotalLength是记录内部使用的高度也就是子View的高度和 而不是LinearLayout的高度</span></div><div class="line">mTotalLength = <span class="number">0</span>;</div><div class="line"><span class="comment">//子视图的最大宽度(不包括layout_weight&gt;0的子View)</span></div><div class="line"><span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> alternativeMaxWidth = <span class="number">0</span>;</div><div class="line"><span class="comment">//子视图的最大宽度(仅包含layout_weight&gt;0的子View)</span></div><div class="line"><span class="keyword">int</span> weightedMaxWidth = <span class="number">0</span>;</div><div class="line"><span class="comment">//子视图是否均为fillParent 用于判断是否需要重新计算</span></div><div class="line"><span class="keyword">boolean</span> allFillParent = <span class="keyword">true</span>;</div><div class="line"><span class="comment">//权重值的总和</span></div><div class="line"><span class="keyword">float</span> totalWeight = <span class="number">0</span>;</div><div class="line"><span class="comment">//子View的数量(统一级别下)</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> count = getVirtualChildCount();</div><div class="line"><span class="comment">//高度宽度模式</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line"><span class="comment">//子View的宽度是否需要由父View决定</span></div><div class="line"><span class="keyword">boolean</span> matchWidth = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">boolean</span> skippedMeasure = <span class="keyword">false</span>;</div><div class="line"><span class="comment">//第几个子View的baseLine作为LinearLayout的基准线</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> baselineChildIndex = mBaselineAlignedChildIndex;  </div><div class="line"><span class="comment">//mUseLargestChild为是否使用最大子元素的尺寸作为标准再次测量</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> useLargestChild = mUseLargestChild;</div><div class="line"><span class="comment">//子View中最高高度</span></div><div class="line"><span class="keyword">int</span> largestChildHeight = Integer.MIN_VALUE;</div></pre></td></tr></table></figure>
<h4 id="第一次测量"><a href="#第一次测量" class="headerlink" title="第一次测量"></a>第一次测量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// See how tall everyone is. Also remember max width.</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">    <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line"></div><div class="line">    <span class="comment">// 测量为null的子视图的高度</span></div><div class="line">    <span class="comment">// measureNullChild() 暂时返回 0 便于扩展</span></div><div class="line">    <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">        mTotalLength += measureNullChild(i);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//Visibility为Gone的时候跳过该View</span></div><div class="line">    <span class="comment">// getChildrenSkipCount()方法同样返回0 便于扩展</span></div><div class="line">    <span class="keyword">if</span> (child.getVisibility() == View.GONE) &#123;</div><div class="line">       i += getChildrenSkipCount(child, i);</div><div class="line">       <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//根据showDivider的值(通过hasDividerBeforeChildAt()) 来决定当前子View是否需要添加分割线的高度</span></div><div class="line">    <span class="keyword">if</span> (hasDividerBeforeChildAt(i)) &#123;</div><div class="line">        mTotalLength += mDividerHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//会将子view的LayoutParams强转为父View的LayoutParams类型</span></div><div class="line">    LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams)child.getLayoutParams();</div><div class="line"></div><div class="line">    totalWeight += lp.weight;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (heightMode == MeasureSpec.EXACTLY &amp;&amp; lp.height == <span class="number">0</span> &amp;&amp; lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 满足该条件的话 不需要现在计算该子视图的高度 测量工作会在之后进行</span></div><div class="line">        <span class="comment">// 若子View的height=0 且weight&gt; 0 则说明该View希望使用的是LinearLayout的剩余空间</span></div><div class="line">        <span class="comment">// LinearLayout是EXACTLY模式的说明LinearLayout高度已经确定 不需要依赖子View的测量结果来计算自己 就无需测量该子View</span></div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + lp.topMargin + lp.bottomMargin);</div><div class="line">        skippedMeasure = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//测量子View</span></div><div class="line"></div><div class="line">        <span class="keyword">int</span> oldHeight = Integer.MIN_VALUE;</div><div class="line"></div><div class="line">        <span class="comment">//当前View的height=0 且weight&gt; 0 则说明该LinearLayout的高度需要靠子View测量(不需要的在上面分支处理了)</span></div><div class="line">        <span class="comment">//将子View的高度设为-1 防止子View高度为0</span></div><div class="line">        <span class="keyword">if</span> (lp.height == <span class="number">0</span> &amp;&amp; lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">            oldHeight = <span class="number">0</span>;</div><div class="line">            lp.height = LayoutParams.WRAP_CONTENT;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//调用子View的measureChildWithMargins() 对子View进行测量</span></div><div class="line">        <span class="comment">//第四个参数表示当前已使用的宽度  因为是竖直模式 所以为0</span></div><div class="line">        <span class="comment">//最后一个参数表示已使用的高度 如果之前的子View或者当前的View有weight属性 则当前子视图使用 LinearLayout 的所有高度 已使用的高度为0</span></div><div class="line">        measureChildBeforeLayout(child, i, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec,</div><div class="line">               totalWeight == <span class="number">0</span> ? mTotalLength : <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (oldHeight != Integer.MIN_VALUE) &#123;</div><div class="line">           <span class="comment">//测量完成后 重置子View高度</span></div><div class="line">           lp.height = oldHeight;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        <span class="comment">// 比较child测量前后总高度 取较大值</span></div><div class="line">        <span class="comment">///getNextLocationOffset() 返回0 便于扩展</span></div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + childHeight + lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</div><div class="line">        <span class="comment">// 设置最高子视图大小</span></div><div class="line">        <span class="keyword">if</span> (useLargestChild) &#123;</div><div class="line">            largestChildHeight = Math.max(childHeight, largestChildHeight);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     <span class="comment">// mBaselineChildTop 表示指定的 baseline 的子视图的顶部高度</span></div><div class="line">    <span class="keyword">if</span> ((baselineChildIndex &gt;= <span class="number">0</span>) &amp;&amp; (baselineChildIndex == i + <span class="number">1</span>)) &#123;</div><div class="line">       mBaselineChildTop = mTotalLength;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 设置为 baseline 的子视图的前面不允许设置 weiget 属性</span></div><div class="line">    <span class="keyword">if</span> (i &lt; baselineChildIndex &amp;&amp; lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"A child of LinearLayout with index "</span></div><div class="line">                + <span class="string">"less than mBaselineAlignedChildIndex has weight &gt; 0, which "</span></div><div class="line">                + <span class="string">"won't work.  Either remove the weight, or don't set "</span></div><div class="line">                + <span class="string">"mBaselineAlignedChildIndex."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 宽度测量相关</span></div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> matchWidthLocally = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">//当LinearLayout非EXACTLY模式 并且自View为MATCH_PARENT时</span></div><div class="line">    <span class="comment">//设置matchWidth和matchWidthLocally为true</span></div><div class="line">    <span class="comment">//该子View占据LinearLayout水平方向上所有空间</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (widthMode != MeasureSpec.EXACTLY &amp;&amp; lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">        matchWidth = <span class="keyword">true</span>;</div><div class="line">        matchWidthLocally = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> margin = lp.leftMargin + lp.rightMargin;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> measuredWidth = child.getMeasuredWidth() + margin;</div><div class="line"></div><div class="line">    <span class="comment">//对一堆变量赋值</span></div><div class="line">    maxWidth = Math.max(maxWidth, measuredWidth);</div><div class="line">    childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line"></div><div class="line">    allFillParent = allFillParent &amp;&amp; lp.width == LayoutParams.MATCH_PARENT;</div><div class="line">    <span class="keyword">if</span> (lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">        weightedMaxWidth = Math.max(weightedMaxWidth,</div><div class="line">                matchWidthLocally ? margin : measuredWidth);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">                matchWidthLocally ? margin : measuredWidth);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    i += getChildrenSkipCount(child, i);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="二次测量mTotalLength"><a href="#二次测量mTotalLength" class="headerlink" title="二次测量mTotalLength"></a>二次测量mTotalLength</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//根据hasDividerBeforeChildAt得到showDivider的值是否为end 来判断是否需要加上divider的高度</span></div><div class="line"><span class="keyword">if</span> (mTotalLength &gt; <span class="number">0</span> &amp;&amp; hasDividerBeforeChildAt(count))</div><div class="line">    mTotalLength += mDividerHeight;</div><div class="line">&#125;</div><div class="line"><span class="comment">//如果高度测量模式为AT_MOST或者UNSPECIFIED 则进行二次测量 且设置了measureWithLargestChild</span></div><div class="line"><span class="keyword">if</span> (useLargestChild &amp;&amp; (heightMode == MeasureSpec.AT_MOST ||</div><div class="line">    heightMode == MeasureSpec.UNSPECIFIED)) &#123;</div><div class="line">    mTotalLength = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">            mTotalLength += measureNullChild(i);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (child.getVisibility() == GONE) &#123;</div><div class="line">            i += getChildrenSkipCount(child, i);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams)</div><div class="line">                child.getLayoutParams();</div><div class="line">        <span class="comment">// 计算所有子View的高度之和</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + largestChildHeight +</div><div class="line">                lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是需要useLargestChild</p>
<p>而 mUseLargestChild = a.getBoolean(R.styleable.LinearLayout_measureWithLargestChild, false);</p>
<p>就是说仅在LinearLayout的measureWithLargestChild属性设置为True时(默认为false)才可能出现某个child被二次测量</p>
<p>实例如下</p>
<p><img src="/LinearLayout二次测量.png" alt="LinearLayout二次测量"></p>
<h4 id="二次测量部分View和对为测量的子View进行测量"><a href="#二次测量部分View和对为测量的子View进行测量" class="headerlink" title="二次测量部分View和对为测量的子View进行测量"></a>二次测量部分View和对为测量的子View进行测量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//加上padding的值</span></div><div class="line">mTotalLength += mPaddingTop + mPaddingBottom;</div><div class="line"><span class="keyword">int</span> heightSize = mTotalLength;</div><div class="line"><span class="comment">//minHeight和当前使用的高度比较取较大值</span></div><div class="line">heightSize = Math.max(heightSize, getSuggestedMinimumHeight());</div><div class="line"></div><div class="line"><span class="comment">//根据heightMeasureSpec协助计算heightSizeAndState的大小</span></div><div class="line"><span class="comment">//resolveSizeAndState方法之后会分析</span></div><div class="line"><span class="keyword">int</span> heightSizeAndState = resolveSizeAndState(heightSize, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">heightSize = heightSizeAndState &amp; MEASURED_SIZE_MASK;</div><div class="line"></div><div class="line"><span class="comment">// Either expand children with weight to take up available space or</span></div><div class="line"><span class="comment">// shrink them if they extend beyond our current bounds. If we skipped</span></div><div class="line"><span class="comment">// measurement on any children, we need to measure them now.</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//delta为额外的空间 及LinearLayout中未被分配的空间(可以为负)</span></div><div class="line"><span class="keyword">int</span> delta = heightSize - mTotalLength;</div><div class="line"><span class="keyword">if</span> (skippedMeasure || delta != <span class="number">0</span> &amp;&amp; totalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">    <span class="comment">//skippedMeasure为第一次测量下对跳过测量的子View设置的</span></div><div class="line">    <span class="comment">//weightSum为权重和 如果设置了总权重则使用我们所设置的  如果没有则使用子View的weight和</span></div><div class="line">    <span class="keyword">float</span> weightSum = mWeightSum &gt; <span class="number">0.0f</span> ? mWeightSum : totalWeight;</div><div class="line"></div><div class="line">    mTotalLength = <span class="number">0</span>;</div><div class="line">    <span class="comment">//测量什么的</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (child.getVisibility() == View.GONE) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">        <span class="keyword">float</span> childExtra = lp.weight;</div><div class="line">        <span class="keyword">if</span> (childExtra &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Child said it could absorb extra space -- give him his share</span></div><div class="line">            <span class="comment">//计算weight属性分配的大小</span></div><div class="line">            <span class="keyword">int</span> share = (<span class="keyword">int</span>) (childExtra * delta / weightSum);</div><div class="line">            <span class="comment">//权重和减去已经分配权重</span></div><div class="line">            weightSum -= childExtra;</div><div class="line">            <span class="comment">//剩余高度减去分配的高度</span></div><div class="line">            delta -= share;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">                    mPaddingLeft + mPaddingRight +</div><div class="line">                            lp.leftMargin + lp.rightMargin, lp.width);</div><div class="line"></div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> Use a field like lp.isMeasured to figure out if this</span></div><div class="line">            <span class="comment">// child has been previously measured</span></div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((lp.height != <span class="number">0</span>) || (heightMode != MeasureSpec.EXACTLY)) &#123;</div><div class="line">                <span class="comment">//子视图已经被测量过</span></div><div class="line">                <span class="comment">//非EXACTLY view需要加上share</span></div><div class="line">                <span class="keyword">int</span> childHeight = child.getMeasuredHeight() + share;</div><div class="line">                <span class="keyword">if</span> (childHeight &lt; <span class="number">0</span>) &#123;</div><div class="line">                    childHeight = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//重新测量View</span></div><div class="line">                child.measure(childWidthMeasureSpec,</div><div class="line">                        MeasureSpec.makeMeasureSpec(childHeight, MeasureSpec.EXACTLY));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//如果当前是EXACTLY模式 说明没有被测量 需要进行测量</span></div><div class="line">                <span class="comment">//子视图首次被测量</span></div><div class="line">                <span class="comment">//EXACTLY模式下 将weight占比的高度分配给子View    </span></div><div class="line">                child.measure(childWidthMeasureSpec,</div><div class="line">                        MeasureSpec.makeMeasureSpec(share &gt; <span class="number">0</span> ? share : <span class="number">0</span>,</div><div class="line">                                MeasureSpec.EXACTLY));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Child may now not fit in vertical dimension.</span></div><div class="line">            childState = combineMeasuredStates(childState, child.getMeasuredState()</div><div class="line">                    &amp; (MEASURED_STATE_MASK&gt;&gt;MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">       <span class="comment">//处理子视图宽度</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> margin =  lp.leftMargin + lp.rightMargin;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> measuredWidth = child.getMeasuredWidth() + margin;</div><div class="line">        maxWidth = Math.max(maxWidth, measuredWidth);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> matchWidthLocally = widthMode != MeasureSpec.EXACTLY &amp;&amp;</div><div class="line">                lp.width == LayoutParams.MATCH_PARENT;</div><div class="line"></div><div class="line">        alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">                matchWidthLocally ? margin : measuredWidth);</div><div class="line"></div><div class="line">        allFillParent = allFillParent &amp;&amp; lp.width == LayoutParams.MATCH_PARENT;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">        mTotalLength = Math.max(totalLength, totalLength + child.getMeasuredHeight() +</div><div class="line">                lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add in our padding</span></div><div class="line">    mTotalLength += mPaddingTop + mPaddingBottom;</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should we recompute the heightSpec based on the new total length?</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">                                   weightedMaxWidth);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// We have no limit, so make all weighted views as tall as the largest child.</span></div><div class="line">    <span class="comment">// Children will have already been measured once.</span></div><div class="line">    <span class="keyword">if</span> (useLargestChild &amp;&amp; heightMode != MeasureSpec.EXACTLY) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (child == <span class="keyword">null</span> || child.getVisibility() == View.GONE) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> LinearLayout.LayoutParams lp =</div><div class="line">                    (LinearLayout.LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">            <span class="keyword">float</span> childExtra = lp.weight;</div><div class="line">            <span class="keyword">if</span> (childExtra &gt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">//使用最大子视图高度测量</span></div><div class="line">                child.measure(</div><div class="line">                        MeasureSpec.makeMeasureSpec(child.getMeasuredWidth(),</div><div class="line">                                MeasureSpec.EXACTLY),</div><div class="line">                        MeasureSpec.makeMeasureSpec(largestChildHeight,</div><div class="line">                                MeasureSpec.EXACTLY));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!allFillParent &amp;&amp; widthMode != MeasureSpec.EXACTLY) &#123;</div><div class="line">    maxWidth = alternativeMaxWidth;</div><div class="line">&#125;</div><div class="line"></div><div class="line">maxWidth += mPaddingLeft + mPaddingRight;</div><div class="line"></div><div class="line"><span class="comment">// Check against our minimum width</span></div><div class="line">maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">        heightSizeAndState);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (matchWidth) &#123;</div><div class="line">    forceUniformWidth(count, heightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>resolveSizeAndState方法 定义在View中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Utility to reconcile a desired size and state, with constraints imposed</div><div class="line">   * by a MeasureSpec. Will take the desired size, unless a different size</div><div class="line">   * is imposed by the constraints. The returned value is a compound integer,</div><div class="line">   * with the resolved size in the &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; bits and</div><div class="line">   * optionally the bit &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125; set if the</div><div class="line">   * resulting size is smaller than the size the view wants to be.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> size How big the view wants to be.</div><div class="line">   * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent.</div><div class="line">   * <span class="doctag">@param</span> childMeasuredState Size information bit mask for the view's</div><div class="line">   *                           children.</div><div class="line">   * <span class="doctag">@return</span> Size information bit mask as defined by</div><div class="line">   *         &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125; and</div><div class="line">   *         &#123;<span class="doctag">@link</span> #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">resolveSizeAndState</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec, <span class="keyword">int</span> childMeasuredState)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> result;</div><div class="line">      <span class="keyword">switch</span> (specMode) &#123;</div><div class="line">          <span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">              <span class="keyword">if</span> (specSize &lt; size) &#123;</div><div class="line">                  result = specSize | MEASURED_STATE_TOO_SMALL;</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  result = size;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          <span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">              result = specSize;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">          <span class="keyword">default</span>:</div><div class="line">              result = size;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> result | (childMeasuredState &amp; MEASURED_STATE_MASK);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h6 id="delta为负的相关解析"><a href="#delta为负的相关解析" class="headerlink" title="delta为负的相关解析"></a>delta为负的相关解析</h6><p>相关代码及效果如下</p>
<p><img src="/负delta.png" alt="负delta.png"></p>
<p>根据之前的measure流程分析一下</p>
<ul>
<li>相关变量初始化</li>
<li>第一次测量  两个子TextView都会被测量 TextView1.height = TextView1.height = 500dp 则mToatalLength为1000dp</li>
<li>mToatalLength再次测量跳过</li>
<li>计算delta delta = heightSize - mTotalLength 根据resolveSizeAndState方法 父LinearLayout是EXACTLY模式 所以最终heightSize为500dp delta = -500dp</li>
<li>根据weight分配剩余空间 TextView1.height = 500 + 1 / 5 <em> (- 500) = 400 dp<br>TextView2.height = 500 + 4 / 5 </em> (- 500) = 100 dp</li>
</ul>
<h3 id="layout过程"><a href="#layout过程" class="headerlink" title="layout过程"></a>layout过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;</div><div class="line">      layoutVertical(l, t, r, b);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      layoutHorizontal(l, t, r, b);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看出 同样是分成水平和竖直两个方向的 同样分析竖直 方向下的layout过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Position the children during a layout pass if the orientation of this</div><div class="line">    * LinearLayout is set to &#123;<span class="doctag">@link</span> #VERTICAL&#125;.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@see</span> #getOrientation()</div><div class="line">    * <span class="doctag">@see</span> #setOrientation(int)</div><div class="line">    * <span class="doctag">@see</span> #onLayout(boolean, int, int, int, int)</div><div class="line">    * <span class="doctag">@param</span> left</div><div class="line">    * <span class="doctag">@param</span> top</div><div class="line">    * <span class="doctag">@param</span> right</div><div class="line">    * <span class="doctag">@param</span> bottom</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">layoutVertical</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> paddingLeft = mPaddingLeft;</div><div class="line"></div><div class="line">       <span class="keyword">int</span> childTop;</div><div class="line">       <span class="keyword">int</span> childLeft;</div><div class="line"></div><div class="line">       <span class="comment">//父View默认子View的宽度</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> width = right - left;</div><div class="line">       <span class="comment">//子View的右侧默认位置</span></div><div class="line">       <span class="keyword">int</span> childRight = width - mPaddingRight;</div><div class="line"></div><div class="line">       <span class="comment">// 子View的可用空间大小</span></div><div class="line">       <span class="keyword">int</span> childSpace = width - paddingLeft - mPaddingRight;</div><div class="line"></div><div class="line">       <span class="comment">//子View的个数</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> count = getVirtualChildCount();</div><div class="line"></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> majorGravity = mGravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> minorGravity = mGravity &amp; Gravity.RELATIVE_HORIZONTAL_GRAVITY_MASK;</div><div class="line"></div><div class="line">       <span class="comment">//根据LinearLayout设置的对其方式 设置第一个子View的Top值</span></div><div class="line">       <span class="keyword">switch</span> (majorGravity) &#123;</div><div class="line">          <span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">              <span class="comment">// mTotalLength contains the padding already</span></div><div class="line">              childTop = mPaddingTop + bottom - top - mTotalLength;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line"></div><div class="line">              <span class="comment">// mTotalLength contains the padding already</span></div><div class="line">          <span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">              childTop = mPaddingTop + (bottom - top - mTotalLength) / <span class="number">2</span>;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> Gravity.TOP:</div><div class="line">          <span class="keyword">default</span>:</div><div class="line">              childTop = mPaddingTop;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//遍历各个子View</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">           <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">           <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">               childTop += measureNullChild(i);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">                <span class="comment">//LinearLayout中子View的宽和高有measure过程决定</span></div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> childWidth = child.getMeasuredWidth();</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div><div class="line">               <span class="comment">//获取子View的LayoutParams</span></div><div class="line">               <span class="keyword">final</span> LinearLayout.LayoutParams lp =</div><div class="line">                       (LinearLayout.LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">               <span class="keyword">int</span> gravity = lp.gravity;</div><div class="line">               <span class="keyword">if</span> (gravity &lt; <span class="number">0</span>) &#123;</div><div class="line">                   gravity = minorGravity;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">               <span class="comment">//根据子View的对其方式设置Left值</span></div><div class="line">               <span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">                   <span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</div><div class="line">                       childLeft = paddingLeft + ((childSpace - childWidth) / <span class="number">2</span>)</div><div class="line">                               + lp.leftMargin - lp.rightMargin;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                   <span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">                       childLeft = childRight - childWidth - lp.rightMargin;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                   <span class="keyword">case</span> Gravity.LEFT:</div><div class="line">                   <span class="keyword">default</span>:</div><div class="line">                       childLeft = paddingLeft + lp.leftMargin;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//如果有分割线 添加分割线的高度</span></div><div class="line">               <span class="keyword">if</span> (hasDividerBeforeChildAt(i)) &#123;</div><div class="line">                   childTop += mDividerHeight;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//子View的top修改</span></div><div class="line">               childTop += lp.topMargin;</div><div class="line">               <span class="comment">//用setChildFrame()方法设置子控件控件的在父控件上的坐标轴</span></div><div class="line">               setChildFrame(child, childLeft, childTop + getLocationOffset(child),</div><div class="line">                       childWidth, childHeight);</div><div class="line">               childTop += childHeight + lp.bottomMargin + getNextLocationOffset(child);</div><div class="line"></div><div class="line">               i += getChildrenSkipCount(child, i);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="draw-源码分析"><a href="#draw-源码分析" class="headerlink" title="draw 源码分析"></a>draw 源码分析</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (mDivider == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;</div><div class="line">      drawDividersVertical(canvas);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      drawDividersHorizontal(canvas);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样主要分析垂直方向的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">drawDividersVertical</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getVirtualChildCount();</div><div class="line">    <span class="comment">//根据计算好的坐标绘制对应的子View</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (child != <span class="keyword">null</span> &amp;&amp; child.getVisibility() != GONE) &#123;</div><div class="line">            <span class="keyword">if</span> (hasDividerBeforeChildAt(i)) &#123;</div><div class="line">                <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> top = child.getTop() - lp.topMargin - mDividerHeight;</div><div class="line">                drawHorizontalDivider(canvas, top);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//绘制分割线</span></div><div class="line">    <span class="keyword">if</span> (hasDividerBeforeChildAt(count)) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getLastNonGoneChild();</div><div class="line">        <span class="keyword">int</span> bottom = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">            bottom = getHeight() - getPaddingBottom() - mDividerHeight;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">            bottom = child.getBottom() + lp.bottomMargin;</div><div class="line">        &#125;</div><div class="line">        drawHorizontalDivider(canvas, bottom);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">drawHorizontalDivider</span><span class="params">(Canvas canvas, <span class="keyword">int</span> top)</span> </span>&#123;</div><div class="line">  mDivider.setBounds(getPaddingLeft() + mDividerPadding, top,</div><div class="line">          getWidth() - getPaddingRight() - mDividerPadding, top + mDividerHeight);</div><div class="line">  mDivider.draw(canvas);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="RelativeLayout-源码分析"><a href="#RelativeLayout-源码分析" class="headerlink" title="RelativeLayout  源码分析"></a>RelativeLayout  源码分析</h2><blockquote>
<p>继承自ViewGroup 没有重载onDraw方法 内部子View又是相对 只要计算出View的坐标 layout过程同样简单</p>
</blockquote>
<h3 id="measure过程-1"><a href="#measure过程-1" class="headerlink" title="measure过程"></a>measure过程</h3><h4 id="主要过程-1"><a href="#主要过程-1" class="headerlink" title="主要过程"></a>主要过程</h4><ol>
<li>将内部View根据纵向关系和横向关系排序</li>
<li>初始化相关变量</li>
<li>遍历水平关系的View</li>
<li>遍历竖直关系的View</li>
<li>baseline计算</li>
<li>宽度和高度修正</li>
</ol>
<h4 id="1-将内部View根据纵向关系和横向关系排序"><a href="#1-将内部View根据纵向关系和横向关系排序" class="headerlink" title="1 将内部View根据纵向关系和横向关系排序"></a>1 将内部View根据纵向关系和横向关系排序</h4><blockquote>
<p>layout_toRightOf 为横向关系  layout_below为纵向关系</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//首先会根据mDirtyHierarchy的值判断是否需要将子View重新排序</span></div><div class="line"><span class="keyword">if</span> (mDirtyHierarchy) &#123;</div><div class="line">    mDirtyHierarchy = <span class="keyword">false</span>;</div><div class="line">    sortChildren();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>相关调用方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//mDirtyHierarchy的值只有在requestLayout方法下被更新</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.requestLayout();</div><div class="line">    mDirtyHierarchy = <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//sortChildren()方法对横向纵向关系的view的数组进行非空判断 用DependencyGraph进行判断</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sortChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line">    <span class="keyword">if</span> (mSortedVerticalChildren == <span class="keyword">null</span> || mSortedVerticalChildren.length != count) &#123;</div><div class="line">        mSortedVerticalChildren = <span class="keyword">new</span> View[count];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mSortedHorizontalChildren == <span class="keyword">null</span> || mSortedHorizontalChildren.length != count) &#123;</div><div class="line">        mSortedHorizontalChildren = <span class="keyword">new</span> View[count];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> DependencyGraph graph = mGraph;</div><div class="line">    graph.clear();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        graph.add(getChildAt(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    graph.getSortedViews(mSortedVerticalChildren, RULES_VERTICAL);</div><div class="line">    graph.getSortedViews(mSortedHorizontalChildren, RULES_HORIZONTAL);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>DependencyGraph的相关方法</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DependencyGraph</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Adds a view to the graph.</div><div class="line">         *</div><div class="line">         * <span class="doctag">@param</span> view The view to be added as a node to the graph.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">            <span class="comment">//因为是图 根据view生成一个节点</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> id = view.getId();</div><div class="line">            <span class="keyword">final</span> Node node = Node.acquire(view);</div><div class="line">            <span class="comment">//如果是有效的id 则将该节点添加到List中</span></div><div class="line">            <span class="keyword">if</span> (id != View.NO_ID) &#123;</div><div class="line">                mKeyNodes.put(id, node);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mNodes.add(node);</div><div class="line">        &#125;     </div><div class="line"></div><div class="line">          <span class="comment">/**</span></div><div class="line">           * Builds a sorted list of views. The sorting order depends on the dependencies</div><div class="line">           * between the view. For instance, if view C needs view A to be processed first</div><div class="line">           * and view A needs view B to be processed first, the dependency graph</div><div class="line">           * is: B -&gt; A -&gt; C. The sorted array will contain views B, A and C in this order.</div><div class="line">           *</div><div class="line">           * <span class="doctag">@param</span> sorted The sorted list of views. The length of this array must</div><div class="line">           *        be equal to getChildCount().</div><div class="line">           * <span class="doctag">@param</span> rules The list of rules to take into account.</div><div class="line">           */</div><div class="line">          <span class="function"><span class="keyword">void</span> <span class="title">getSortedViews</span><span class="params">(View[] sorted, <span class="keyword">int</span>... rules)</span> </span>&#123;</div><div class="line">            <span class="comment">//当前View找不到其它的可依赖的View时  作为root节点</span></div><div class="line">              <span class="keyword">final</span> ArrayDeque&lt;Node&gt; roots = findRoots(rules);</div><div class="line">              <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line"></div><div class="line">              Node node;</div><div class="line">              <span class="comment">//读取root的下一个node</span></div><div class="line">              <span class="keyword">while</span> ((node = roots.pollLast()) != <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">final</span> View view = node.view;</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> key = view.getId();</div><div class="line"></div><div class="line">              <span class="comment">//将符合规则的View加到 sorted中</span></div><div class="line"></div><div class="line">                  sorted[index++] = view;</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> ArrayMap&lt;Node, DependencyGraph&gt; dependents = node.dependents;</div><div class="line">                  <span class="comment">//dependents 依赖该node的node  (A C依赖B 则B的dependents中存A C)</span></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> count = dependents.size();</div><div class="line">                  <span class="comment">//遍历所有依赖自己的node</span></div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                      <span class="keyword">final</span> Node dependent = dependents.keyAt(i);</div><div class="line">                      <span class="comment">//dependencies 是被依赖的的node的规则和node(A 依赖 B D 则dependencies存有B D )</span></div><div class="line">                      <span class="keyword">final</span> SparseArray&lt;Node&gt; dependencies = dependent.dependencies;</div><div class="line"></div><div class="line">                      <span class="comment">//移除当前node和dependencies的依赖关系</span></div><div class="line">                      dependencies.remove(key);</div><div class="line">                      <span class="comment">//如果解除依赖后没有其它依赖 则将该node也视为rootNode</span></div><div class="line">                      <span class="keyword">if</span> (dependencies.size() == <span class="number">0</span>) &#123;</div><div class="line">                          roots.add(dependent);</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (index &lt; sorted.length) &#123;</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Circular dependencies cannot exist in RelativeLayout"</span>);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>eg: A依赖B B依赖C 首先存入C 因为不依赖任何其它的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Finds the roots of the graph. A root is a node with no dependency and</div><div class="line"> * with [0..n] dependents.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> rulesFilter The list of rules to consider when building the</div><div class="line"> *        dependencies</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> A list of node, each being a root of the graph</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> ArrayDeque&lt;Node&gt; <span class="title">findRoots</span><span class="params">(<span class="keyword">int</span>[] rulesFilter)</span> </span>&#123;</div><div class="line">  <span class="comment">//keyNodes为nodelist</span></div><div class="line">    <span class="keyword">final</span> SparseArray&lt;Node&gt; keyNodes = mKeyNodes;</div><div class="line">    <span class="keyword">final</span> ArrayList&lt;Node&gt; nodes = mNodes;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = nodes.size();</div><div class="line"></div><div class="line">  <span class="comment">//初始化依赖该node的node和该node依赖的node相关参数</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> Node node = nodes.get(i);</div><div class="line">        node.dependents.clear();</div><div class="line">        node.dependencies.clear();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//遍历所有node  存入当前view和他所依赖的关系</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> Node node = nodes.get(i);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> LayoutParams layoutParams = (LayoutParams) node.view.getLayoutParams();</div><div class="line">        <span class="comment">//取出当前View所有的依赖关系</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] rules = layoutParams.mRules;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> rulesCount = rulesFilter.length;</div><div class="line"></div><div class="line">        <span class="comment">//遍历当前View所有的</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; rulesCount; j++) &#123;</div><div class="line">          <span class="comment">//rule对应被依赖view的id</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> rule = rules[rulesFilter[j]];</div><div class="line">            <span class="keyword">if</span> (rule &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">//找到被依赖的node</span></div><div class="line">                <span class="keyword">final</span> Node dependency = keyNodes.get(rule);</div><div class="line">                <span class="comment">//跳过空view和本身</span></div><div class="line">                <span class="keyword">if</span> (dependency == <span class="keyword">null</span> || dependency == node) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//添加依赖被依赖的node</span></div><div class="line">                dependency.dependents.put(node, <span class="keyword">this</span>);</div><div class="line">                node.dependencies.put(rule, dependency);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ArrayDeque&lt;Node&gt; roots = mRoots;</div><div class="line">    roots.clear();</div><div class="line"></div><div class="line">    <span class="comment">// 再次遍历  如果该node的依赖关系为0 即该view不依赖任何view 则视为rootView</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> Node node = nodes.get(i);</div><div class="line">        <span class="keyword">if</span> (node.dependencies.size() == <span class="number">0</span>) roots.addLast(node);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> roots;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-初始化相关变量"><a href="#2-初始化相关变量" class="headerlink" title="2 初始化相关变量"></a>2 初始化相关变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> myWidth = -<span class="number">1</span>;</div><div class="line"><span class="keyword">int</span> myHeight = -<span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> width = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> height = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line"></div><div class="line"><span class="comment">// 如果不是UNSPECIFIED模式 则将widthSize赋值于myWidth</span></div><div class="line"><span class="keyword">if</span> (widthMode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">    myWidth = widthSize;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 如果不是UNSPECIFIED模式 则将heightSize赋值于myHeight</span></div><div class="line"><span class="keyword">if</span> (heightMode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">    myHeight = heightSize;</div><div class="line">&#125;</div><div class="line"><span class="comment">//如果是EXACTLY模式 则将myWidth和myHeight记录</span></div><div class="line"><span class="keyword">if</span> (widthMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">    width = myWidth;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (heightMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">    height = myHeight;</div><div class="line">&#125;</div><div class="line"></div><div class="line">View ignore = <span class="keyword">null</span>;</div><div class="line"><span class="comment">//判断是否为Start 和  top 确定左上角坐标</span></div><div class="line"><span class="keyword">int</span> gravity = mGravity &amp; Gravity.RELATIVE_HORIZONTAL_GRAVITY_MASK;</div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> horizontalGravity = gravity != Gravity.START &amp;&amp; gravity != <span class="number">0</span>;</div><div class="line">gravity = mGravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> verticalGravity = gravity != Gravity.TOP &amp;&amp; gravity != <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> left = Integer.MAX_VALUE;</div><div class="line"><span class="keyword">int</span> top = Integer.MAX_VALUE;</div><div class="line"><span class="keyword">int</span> right = Integer.MIN_VALUE;</div><div class="line"><span class="keyword">int</span> bottom = Integer.MIN_VALUE;</div><div class="line"></div><div class="line"><span class="keyword">boolean</span> offsetHorizontalAxis = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">boolean</span> offsetVerticalAxis = <span class="keyword">false</span>;</div><div class="line"><span class="comment">// 记录ignore的view</span></div><div class="line"><span class="keyword">if</span> ((horizontalGravity || verticalGravity) &amp;&amp; mIgnoreGravity != View.NO_ID) &#123;</div><div class="line">    ignore = findViewById(mIgnoreGravity);</div><div class="line">&#125;</div><div class="line"><span class="comment">//宽度个高度是否为warp模式</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> isWrapContentWidth = widthMode != MeasureSpec.EXACTLY;</div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> isWrapContentHeight = heightMode != MeasureSpec.EXACTLY;</div><div class="line"></div><div class="line"><span class="comment">//在计算和分配的子View的坐标的时候 需要用到父VIew的尺寸 但是暂时无法拿到准确值(待完成下面操作)</span></div><div class="line"><span class="comment">//先使用默认值代替 在计算后 用偏移量更新真是坐标</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line"><span class="keyword">if</span> (isLayoutRtl() &amp;&amp; myWidth == -<span class="number">1</span>) &#123;</div><div class="line">    myWidth = DEFAULT_WIDTH;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-遍历水平关系的View"><a href="#3-遍历水平关系的View" class="headerlink" title="3  遍历水平关系的View"></a>3  遍历水平关系的View</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">View[] views = mSortedHorizontalChildren;</div><div class="line"><span class="keyword">int</span> count = views.length;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">    View child = views[i];</div><div class="line">    <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">        LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">        <span class="comment">//根据方向获得子View中设置的规则</span></div><div class="line">        <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</div><div class="line">        <span class="comment">//将左右方向规则转换为左右的坐标</span></div><div class="line">        applyHorizontalSizeRules(params, myWidth, rules);</div><div class="line">        <span class="comment">//测算水平方向的子View的尺寸</span></div><div class="line">        measureChildHorizontal(child, params, myWidth, myHeight);</div><div class="line">        <span class="comment">//确定水平方向子View的位置</span></div><div class="line">        <span class="keyword">if</span> (positionChildHorizontal(child, params, myWidth, isWrapContentWidth)) &#123;</div><div class="line">            offsetHorizontalAxis = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>相关方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyHorizontalSizeRules</span><span class="params">(LayoutParams childParams, <span class="keyword">int</span> myWidth, <span class="keyword">int</span>[] rules)</span> </span>&#123;</div><div class="line">    RelativeLayout.LayoutParams anchorParams;</div><div class="line">    childParams.mLeft = VALUE_NOT_SET;</div><div class="line">    childParams.mRight = VALUE_NOT_SET;</div><div class="line">    <span class="comment">//得到当前子View的layout_toLeftOf属性对应的View</span></div><div class="line">    anchorParams = getRelatedViewParams(rules, LEFT_OF);</div><div class="line">    <span class="keyword">if</span> (anchorParams != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//如果这个属性存在 则当前子View的右坐标是layout_toLeftOf对应的view的左坐标减去对应view的marginLeft的值和自身marginRight的值</span></div><div class="line">        childParams.mRight = anchorParams.mLeft - (anchorParams.leftMargin +</div><div class="line">                childParams.rightMargin);</div><div class="line">    <span class="comment">//如果alignWithParent为true alignWithParent取alignWithParentIfMissing</span></div><div class="line">    <span class="comment">//如果layout_toLeftOf的view为空 或者gone 则将RelativeLayout当做被依赖的对象</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childParams.alignWithParent &amp;&amp; rules[LEFT_OF] != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//如果父容器RelativeLayout的宽度大于0</span></div><div class="line">        <span class="comment">//则子View的右坐标为 父RelativeLayout的宽度减去 mPaddingRight 和自身的marginRight</span></div><div class="line">        <span class="keyword">if</span> (myWidth &gt;= <span class="number">0</span>) &#123;</div><div class="line">            childParams.mRight = myWidth - mPaddingRight - childParams.rightMargin;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//类似的方法 得到左坐标(通过参数RIGHT_OF)</span></div><div class="line">    anchorParams = getRelatedViewParams(rules, RIGHT_OF);</div><div class="line">    <span class="keyword">if</span> (anchorParams != <span class="keyword">null</span>) &#123;</div><div class="line">        childParams.mLeft = anchorParams.mRight + (anchorParams.rightMargin +</div><div class="line">                childParams.leftMargin);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childParams.alignWithParent &amp;&amp; rules[RIGHT_OF] != <span class="number">0</span>) &#123;</div><div class="line">        childParams.mLeft = mPaddingLeft + childParams.leftMargin;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//类似的方法 得到左坐标 (通过参数ALIGN_LEFT)</span></div><div class="line">    anchorParams = getRelatedViewParams(rules, ALIGN_LEFT);</div><div class="line">    <span class="keyword">if</span> (anchorParams != <span class="keyword">null</span>) &#123;</div><div class="line">        childParams.mLeft = anchorParams.mLeft + childParams.leftMargin;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childParams.alignWithParent &amp;&amp; rules[ALIGN_LEFT] != <span class="number">0</span>) &#123;</div><div class="line">        childParams.mLeft = mPaddingLeft + childParams.leftMargin;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//类似的方法 得到右坐标 (通过参数ALIGN_RIGHT)</span></div><div class="line">    anchorParams = getRelatedViewParams(rules, ALIGN_RIGHT);</div><div class="line">    <span class="keyword">if</span> (anchorParams != <span class="keyword">null</span>) &#123;</div><div class="line">        childParams.mRight = anchorParams.mRight - childParams.rightMargin;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childParams.alignWithParent &amp;&amp; rules[ALIGN_RIGHT] != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (myWidth &gt;= <span class="number">0</span>) &#123;</div><div class="line">            childParams.mRight = myWidth - mPaddingRight - childParams.rightMargin;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//根据ALIGN_PARENT_LEFT 将自己放到父RelativeLayout的左边</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != rules[ALIGN_PARENT_LEFT]) &#123;</div><div class="line">        childParams.mLeft = mPaddingLeft + childParams.leftMargin;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//根据ALIGN_PARENT_RIGHT 将自己放到父RelativeLayout的右边</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != rules[ALIGN_PARENT_RIGHT]) &#123;</div><div class="line">        <span class="keyword">if</span> (myWidth &gt;= <span class="number">0</span>) &#123;</div><div class="line">            childParams.mRight = myWidth - mPaddingRight - childParams.rightMargin;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">measureChildHorizontal</span><span class="params">(View child, LayoutParams params, <span class="keyword">int</span> myWidth, <span class="keyword">int</span> myHeight)</span> </span>&#123;</div><div class="line">  <span class="comment">//获得child的宽度MeasureSpec</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(params.mLeft, params.mRight,</div><div class="line">            params.width, params.leftMargin, params.rightMargin, mPaddingLeft, mPaddingRight,</div><div class="line">            myWidth);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec;</div><div class="line">    <span class="comment">//在低于4.2的时候 mAllowBrokenMeasureSpecs为true</span></div><div class="line">    <span class="comment">//当myHeight &lt; 0 时 则根据父RelativeLayout设置其MeasureSpec模式</span></div><div class="line">    <span class="keyword">if</span> (myHeight &lt; <span class="number">0</span> &amp;&amp; !mAllowBrokenMeasureSpecs) &#123;</div><div class="line">        <span class="comment">//如果父RelativeLayout的height大于0  则 设置子view的MeasureSpec模式为EXACTLY</span></div><div class="line">        <span class="keyword">if</span> (params.height &gt;= <span class="number">0</span>) &#123;</div><div class="line">            childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                    params.height, MeasureSpec.EXACTLY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//反之 如果其小于0  则设置子View的MeasureSpec为UNSPECIFIED</span></div><div class="line">            childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(<span class="number">0</span>, MeasureSpec.UNSPECIFIED);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//当当前myHeight &gt;= 0</span></div><div class="line">      <span class="comment">//判断当前高度是否与父RelativeLayout高度相同 设置heightMode</span></div><div class="line">      <span class="comment">//根据maxHeight 和heightMode设置子View的MeasureSpec模式</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> maxHeight;</div><div class="line">        <span class="keyword">if</span> (mMeasureVerticalWithPaddingMargin) &#123;</div><div class="line">            maxHeight = Math.max(<span class="number">0</span>, myHeight - mPaddingTop - mPaddingBottom</div><div class="line">                    - params.topMargin - params.bottomMargin);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            maxHeight = Math.max(<span class="number">0</span>, myHeight);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> heightMode;</div><div class="line">        <span class="keyword">if</span> (params.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            heightMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            heightMode = MeasureSpec.AT_MOST;</div><div class="line">        &#125;</div><div class="line">        childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(maxHeight, heightMode);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获得了子View的WidthMeasureSpec和HeightMeasureSpec</span></div><div class="line">    <span class="comment">//子View可以通过measure方法获取自身的size</span></div><div class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Get a measure spec that accounts for all of the constraints on this view.</div><div class="line">    * This includes size constraints imposed by the RelativeLayout as well as</div><div class="line">    * the View's desired dimension.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> childStart The left or top field of the child's layout params</div><div class="line">    * <span class="doctag">@param</span> childEnd The right or bottom field of the child's layout params</div><div class="line">    * <span class="doctag">@param</span> childSize The child's desired size (the width or height field of</div><div class="line">    *        the child's layout params)</div><div class="line">    * <span class="doctag">@param</span> startMargin The left or top margin</div><div class="line">    * <span class="doctag">@param</span> endMargin The right or bottom margin</div><div class="line">    * <span class="doctag">@param</span> startPadding mPaddingLeft or mPaddingTop</div><div class="line">    * <span class="doctag">@param</span> endPadding mPaddingRight or mPaddingBottom</div><div class="line">    * <span class="doctag">@param</span> mySize The width or height of this view (the RelativeLayout)</div><div class="line">    * <span class="doctag">@return</span> MeasureSpec for the child</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> childStart, <span class="keyword">int</span> childEnd,</span></span></div><div class="line">           <span class="keyword">int</span> childSize, <span class="keyword">int</span> startMargin, <span class="keyword">int</span> endMargin, <span class="keyword">int</span> startPadding,</div><div class="line">           <span class="keyword">int</span> endPadding, <span class="keyword">int</span> mySize) &#123;</div><div class="line">       <span class="keyword">int</span> childSpecMode = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> childSpecSize = <span class="number">0</span>;</div><div class="line"></div><div class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> isUnspecified = mySize &lt; <span class="number">0</span>;</div><div class="line">       <span class="comment">//如果父RelativeLayout宽度小于0 版本号不小于4.2</span></div><div class="line">       <span class="keyword">if</span> (isUnspecified &amp;&amp; !mAllowBrokenMeasureSpecs) &#123;</div><div class="line">            <span class="comment">//如果子View的左边距和右边距都不为VALUE_NOT_SET</span></div><div class="line">            <span class="comment">//且右边距坐标大于左边距坐标 则将其差当做宽度赋予View 设置模式为EXACTLY</span></div><div class="line">            <span class="comment">//VALUE_NOT_SET = Integer.MIN_VALUE</span></div><div class="line">            <span class="comment">/**</span></div><div class="line">             * Constant for the minimum &#123;<span class="doctag">@code</span> int&#125; value, -2&lt;sup&gt;31&lt;/sup&gt;.</div><div class="line">             */</div><div class="line">            <span class="comment">//public static final int MIN_VALUE = 0x80000000;</span></div><div class="line">           <span class="keyword">if</span> (childStart != VALUE_NOT_SET &amp;&amp; childEnd != VALUE_NOT_SET) &#123;</div><div class="line">               childSpecSize = Math.max(<span class="number">0</span>, childEnd - childStart);</div><div class="line">               childSpecMode = MeasureSpec.EXACTLY;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childSize &gt;= <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">// 如果childSpecSize &gt;= 0 则赋值于childSpecSize</span></div><div class="line">               <span class="comment">//同样设置模式为EXACTLY</span></div><div class="line">               childSpecSize = childSize;</div><div class="line">               childSpecMode = MeasureSpec.EXACTLY;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// 都不满足则设置模式为UNSPECIFIED</span></div><div class="line">               childSpecSize = <span class="number">0</span>;</div><div class="line">               childSpecMode = MeasureSpec.UNSPECIFIED;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(childSpecSize, childSpecMode);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 计算 开始和结束相关</span></div><div class="line">       <span class="keyword">int</span> tempStart = childStart;</div><div class="line">       <span class="keyword">int</span> tempEnd = childEnd;</div><div class="line"></div><div class="line">       <span class="comment">//如果没有指定start值 则默认赋予 padding和merage的值</span></div><div class="line">       <span class="keyword">if</span> (tempStart == VALUE_NOT_SET) &#123;</div><div class="line">           tempStart = startPadding + startMargin;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//同上</span></div><div class="line">       <span class="keyword">if</span> (tempEnd == VALUE_NOT_SET) &#123;</div><div class="line">           tempEnd = mySize - endPadding - endMargin;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//指定最大可提供的大小</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> maxAvailable = tempEnd - tempStart;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (childStart != VALUE_NOT_SET &amp;&amp; childEnd != VALUE_NOT_SET) &#123;</div><div class="line">           <span class="comment">//如果Start和End都是有效值 根据isUnspecified设置specMode为UNSPECIFIED或EXACTLY</span></div><div class="line">           <span class="comment">//并将设置对应的size</span></div><div class="line">           childSpecMode = isUnspecified ? MeasureSpec.UNSPECIFIED : MeasureSpec.EXACTLY;</div><div class="line">           childSpecSize = Math.max(<span class="number">0</span>, maxAvailable);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//反之 判断childSize的相关值</span></div><div class="line">           <span class="keyword">if</span> (childSize &gt;= <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">//设置模式为EXACTLY</span></div><div class="line">               <span class="comment">//判断maxAvailable和childSize情况 取较大值设置为childSpecSize</span></div><div class="line">               childSpecMode = MeasureSpec.EXACTLY;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (maxAvailable &gt;= <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">// We have a maximum size in this dimension.</span></div><div class="line">                   childSpecSize = Math.min(maxAvailable, childSize);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// We can grow in this dimension.</span></div><div class="line">                   childSpecSize = childSize;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childSize == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">               <span class="comment">//如果子View是match模式 参照isUnspecified设置相关</span></div><div class="line">               childSpecMode = isUnspecified ? MeasureSpec.UNSPECIFIED : MeasureSpec.EXACTLY;</div><div class="line">               childSpecSize = Math.max(<span class="number">0</span>, maxAvailable);</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childSize == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">               <span class="comment">//在wrap进行设置</span></div><div class="line">               <span class="keyword">if</span> (maxAvailable &gt;= <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">// We have a maximum size in this dimension.</span></div><div class="line">                   childSpecMode = MeasureSpec.AT_MOST;</div><div class="line">                   childSpecSize = maxAvailable;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// We can grow in this dimension. Child can be as big as it</span></div><div class="line">                   <span class="comment">// wants.</span></div><div class="line">                   childSpecMode = MeasureSpec.UNSPECIFIED;</div><div class="line">                   childSpecSize = <span class="number">0</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(childSpecSize, childSpecMode);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>以上 完成了View的第一次测量  确定了View的大小 然后根据大小觉得把子view放在父RelativeLayout中的位置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">positionChildHorizontal</span><span class="params">(View child, LayoutParams params, <span class="keyword">int</span> myWidth,</span></span></div><div class="line">        <span class="keyword">boolean</span> wrapContent) &#123;</div><div class="line">    <span class="comment">//获取RelativeLayout的布局方向</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">    <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (params.mLeft == VALUE_NOT_SET &amp;&amp; params.mRight != VALUE_NOT_SET) &#123;</div><div class="line">        <span class="comment">// 如果右边界有效 左边界无效 根据右边界计算出左边界</span></div><div class="line">        params.mLeft = params.mRight - child.getMeasuredWidth();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.mLeft != VALUE_NOT_SET &amp;&amp; params.mRight == VALUE_NOT_SET) &#123;</div><div class="line">        <span class="comment">// 同上反之</span></div><div class="line">        params.mRight = params.mLeft + child.getMeasuredWidth();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.mLeft == VALUE_NOT_SET &amp;&amp; params.mRight == VALUE_NOT_SET) &#123;</div><div class="line">        <span class="comment">//都无效的时候</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (rules[CENTER_IN_PARENT] != <span class="number">0</span> || rules[CENTER_HORIZONTAL] != <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">//设置了CENTER_IN_PARENT或者 CENTER_HORIZONTAL的情况下</span></div><div class="line">            <span class="keyword">if</span> (!wrapContent) &#123;</div><div class="line">              <span class="comment">//非wrap情况下</span></div><div class="line">              <span class="comment">//把子View水平中心固定在RelativeLayout的中心</span></div><div class="line">                centerHorizontal(child, params, myWidth);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">//左边距为padding+margin</span></div><div class="line">               <span class="comment">//右边距为左边距加上测量宽度</span></div><div class="line">                params.mLeft = mPaddingLeft + params.leftMargin;</div><div class="line">                params.mRight = params.mLeft + child.getMeasuredWidth();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//RTL右到左 布局方向</span></div><div class="line">            <span class="comment">//LTR左到右 布局方向</span></div><div class="line">            <span class="keyword">if</span> (isLayoutRtl()) &#123;</div><div class="line">                params.mRight = myWidth - mPaddingRight- params.rightMargin;</div><div class="line">                params.mLeft = params.mRight - child.getMeasuredWidth();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                params.mLeft = mPaddingLeft + params.leftMargin;</div><div class="line">                params.mRight = params.mLeft + child.getMeasuredWidth();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> rules[ALIGN_PARENT_END] != <span class="number">0</span>;</div><div class="line">    <span class="comment">//当为CENTER_IN_PARENT  CENTER_HORIZONTAL ALIGN_PARENT_END三种情况之一时返回True</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-遍历竖直关系的View"><a href="#4-遍历竖直关系的View" class="headerlink" title="4 遍历竖直关系的View"></a>4 遍历竖直关系的View</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">           <span class="keyword">final</span> View child = views[i];</div><div class="line">           <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">               <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">              <span class="comment">//将竖直方向规则转换为坐标</span></div><div class="line">               applyVerticalSizeRules(params, myHeight, child.getBaseline());</div><div class="line">               <span class="comment">//测量子View</span></div><div class="line">               measureChild(child, params, myWidth, myHeight);</div><div class="line">               <span class="comment">//确定竖直方向子View的位置</span></div><div class="line">               <span class="keyword">if</span> (positionChildVertical(child, params, myHeight, isWrapContentHeight)) &#123;</div><div class="line">                   offsetVerticalAxis = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">              <span class="comment">//首先判断是否为wrap模式</span></div><div class="line">               <span class="keyword">if</span> (isWrapContentWidth) &#123;</div><div class="line">                 <span class="comment">//根据RTL或者LTR和版本进行区分</span></div><div class="line">                 <span class="comment">//Build.VERSION_CODES.KITKAT = 19</span></div><div class="line">                 <span class="comment">//主要对margin进行处理</span></div><div class="line">                   <span class="keyword">if</span> (isLayoutRtl()) &#123;</div><div class="line">                       <span class="keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">                           width = Math.max(width, myWidth - params.mLeft);</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                           width = Math.max(width, myWidth - params.mLeft - params.leftMargin);</div><div class="line">                       &#125;</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">                           width = Math.max(width, params.mRight);</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                           width = Math.max(width, params.mRight + params.rightMargin);</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (isWrapContentHeight) &#123;</div><div class="line">                   <span class="keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">                       height = Math.max(height, params.mBottom);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       height = Math.max(height, params.mBottom + params.bottomMargin);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (child != ignore || verticalGravity) &#123;</div><div class="line">                   left = Math.min(left, params.mLeft - params.leftMargin);</div><div class="line">                   top = Math.min(top, params.mTop - params.topMargin);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (child != ignore || horizontalGravity) &#123;</div><div class="line">                   right = Math.max(right, params.mRight + params.rightMargin);</div><div class="line">                   bottom = Math.max(bottom, params.mBottom + params.bottomMargin);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="5-baseline计算"><a href="#5-baseline计算" class="headerlink" title="5 baseline计算"></a>5 baseline计算</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Use the top-start-most laid out view as the baseline. RTL offsets are</span></div><div class="line"><span class="comment">// applied later, so we can use the left-most edge as the starting edge.</span></div><div class="line">    View baselineView = <span class="keyword">null</span>;</div><div class="line">    LayoutParams baselineParams = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> View child = views[i];</div><div class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">            <span class="keyword">final</span> LayoutParams childParams = (LayoutParams) child.getLayoutParams();</div><div class="line">            <span class="keyword">if</span> (baselineView == <span class="keyword">null</span> || baselineParams == <span class="keyword">null</span></div><div class="line">                    || compareLayoutPosition(childParams, baselineParams) &lt; <span class="number">0</span>) &#123;</div><div class="line">                baselineView = child;</div><div class="line">                baselineParams = childParams;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    mBaselineView = baselineView;</div></pre></td></tr></table></figure>
<h4 id="6-宽度和高度修正"><a href="#6-宽度和高度修正" class="headerlink" title="6 宽度和高度修正"></a>6 宽度和高度修正</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//如何是wrap模式</span></div><div class="line"><span class="keyword">if</span> (isWrapContentWidth) &#123;</div><div class="line">        width += mPaddingRight;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mLayoutParams != <span class="keyword">null</span> &amp;&amp; mLayoutParams.width &gt;= <span class="number">0</span>) &#123;</div><div class="line">            width = Math.max(width, mLayoutParams.width);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        width = Math.max(width, getSuggestedMinimumWidth());</div><div class="line">        width = resolveSize(width, widthMeasureSpec);</div><div class="line"></div><div class="line">        <span class="comment">//在得到最后的width之后 对依赖RelativeLayout的子View添上偏移量</span></div><div class="line">        <span class="keyword">if</span> (offsetHorizontalAxis) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = views[i];</div><div class="line">                <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">                    <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</div><div class="line">                    <span class="comment">//对CENTER_IN_PARENT或者CENTER_HORIZONTAL的子View重测</span></div><div class="line">                    <span class="keyword">if</span> (rules[CENTER_IN_PARENT] != <span class="number">0</span> || rules[CENTER_HORIZONTAL] != <span class="number">0</span>) &#123;</div><div class="line">                        centerHorizontal(child, params, width);</div><div class="line">                    <span class="comment">//对ALIGN_PARENT_RIGHT重测</span></div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rules[ALIGN_PARENT_RIGHT] != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> childWidth = child.getMeasuredWidth();</div><div class="line">                        params.mLeft = width - mPaddingRight - childWidth;</div><div class="line">                        params.mRight = params.mLeft + childWidth;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//同上</span></div><div class="line">    <span class="keyword">if</span> (isWrapContentHeight) &#123;</div><div class="line">        height += mPaddingBottom;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mLayoutParams != <span class="keyword">null</span> &amp;&amp; mLayoutParams.height &gt;= <span class="number">0</span>) &#123;</div><div class="line">            height = Math.max(height, mLayoutParams.height);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        height = Math.max(height, getSuggestedMinimumHeight());</div><div class="line">        height = resolveSize(height, heightMeasureSpec);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (offsetVerticalAxis) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = views[i];</div><div class="line">                <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">                    <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</div><div class="line">                    <span class="keyword">if</span> (rules[CENTER_IN_PARENT] != <span class="number">0</span> || rules[CENTER_VERTICAL] != <span class="number">0</span>) &#123;</div><div class="line">                        centerVertical(child, params, height);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rules[ALIGN_PARENT_BOTTOM] != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div><div class="line">                        params.mTop = height - mPaddingBottom - childHeight;</div><div class="line">                        params.mBottom = params.mTop + childHeight;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//根据gravity再次修正</span></div><div class="line">    <span class="keyword">if</span> (horizontalGravity || verticalGravity) &#123;</div><div class="line">        <span class="keyword">final</span> Rect selfBounds = mSelfBounds;</div><div class="line">        selfBounds.set(mPaddingLeft, mPaddingTop, width - mPaddingRight,</div><div class="line">                height - mPaddingBottom);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Rect contentBounds = mContentBounds;</div><div class="line">        Gravity.apply(mGravity, right - left, bottom - top, selfBounds, contentBounds,</div><div class="line">                layoutDirection);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> horizontalOffset = contentBounds.left - left;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> verticalOffset = contentBounds.top - top;</div><div class="line">        <span class="keyword">if</span> (horizontalOffset != <span class="number">0</span> || verticalOffset != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = views[i];</div><div class="line">                <span class="keyword">if</span> (child.getVisibility() != GONE &amp;&amp; child != ignore) &#123;</div><div class="line">                    <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                    <span class="keyword">if</span> (horizontalGravity) &#123;</div><div class="line">                        params.mLeft += horizontalOffset;</div><div class="line">                        params.mRight += horizontalOffset;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (verticalGravity) &#123;</div><div class="line">                        params.mTop += verticalOffset;</div><div class="line">                        params.mBottom += verticalOffset;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//如果是RTL(右到左显示)则再次修改</span></div><div class="line">    <span class="keyword">if</span> (isLayoutRtl()) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> offsetWidth = myWidth - width;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            <span class="keyword">final</span> View child = views[i];</div><div class="line">            <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">                <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                params.mLeft -= offsetWidth;</div><div class="line">                params.mRight -= offsetWidth;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="简单总结"><a href="#简单总结" class="headerlink" title="简单总结"></a>简单总结</h4><p>RelativeLayout更加关注子View的left right top bottom值 并且优先级高于width和height</p>
<h3 id="RelativeLayout的layout过程"><a href="#RelativeLayout的layout过程" class="headerlink" title="RelativeLayout的layout过程"></a>RelativeLayout的layout过程</h3><p>对于RelativeLayout来的 layout过程更多的根据子View的left right top bottom值来设定位置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">    <span class="comment">//  The layout has actually already been performed and the positions</span></div><div class="line">    <span class="comment">//  cached.  Apply the cached values to the children.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        View child = getChildAt(i);</div><div class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">            RelativeLayout.LayoutParams st =</div><div class="line">                    (RelativeLayout.LayoutParams) child.getLayoutParams();</div><div class="line">            child.layout(st.mLeft, st.mTop, st.mRight, st.mBottom);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="RelativeLayout的draw过程"><a href="#RelativeLayout的draw过程" class="headerlink" title="RelativeLayout的draw过程"></a>RelativeLayout的draw过程</h3><p>RelativeLayout作为ViewGroup的子类 因为其性质原因  没有对draw过程进行修改</p>
<p>以上</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table Des Matières
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Ensemble
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/myimage.jpeg"
               alt="clwater" />
          <p class="site-author-name" itemprop="name">clwater</p>
          <p class="site-description motion-element" itemprop="description">aaa</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">articles</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-View"><span class="nav-number">1.</span> <span class="nav-text">Android View</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#从setContentView与LayoutInflater说起"><span class="nav-number">1.1.</span> <span class="nav-text">从setContentView与LayoutInflater说起</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#setContentView分析"><span class="nav-number">1.1.1.</span> <span class="nav-text">setContentView分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#相关关系"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">相关关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PhoneWindow的setContentView分析"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">PhoneWindow的setContentView分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LayoutInflater源码分析"><span class="nav-number">1.1.2.</span> <span class="nav-text">LayoutInflater源码分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View的测量-布局-绘制过程"><span class="nav-number">1.2.</span> <span class="nav-text">View的测量 布局 绘制过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#测量之前的事情"><span class="nav-number">1.2.1.</span> <span class="nav-text">测量之前的事情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#measure源码分析"><span class="nav-number">1.2.2.</span> <span class="nav-text">measure源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#layout源码分析"><span class="nav-number">1.2.3.</span> <span class="nav-text">layout源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#draw源码分析"><span class="nav-number">1.2.4.</span> <span class="nav-text">draw源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-1-draw-the-background-if-needed"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">Step 1, draw the background, if needed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-2-save-the-canvas’-layers"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">Step 2, save the canvas’ layers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-3-draw-the-content"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">Step 3, draw the content</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-4-draw-the-children"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">Step 4, draw the children</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-5-draw-the-fade-effect-and-restore-layers"><span class="nav-number">1.2.4.5.</span> <span class="nav-text">Step 5, draw the fade effect and restore layers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-6-draw-decorations-scrollbars"><span class="nav-number">1.2.4.6.</span> <span class="nav-text">Step 6, draw decorations (scrollbars)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LinearLayout-源码分析"><span class="nav-number">1.3.</span> <span class="nav-text">LinearLayout 源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#measure过程"><span class="nav-number">1.3.1.</span> <span class="nav-text">measure过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主要过程"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">主要过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化相关变量"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">初始化相关变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第一次测量"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">第一次测量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二次测量mTotalLength"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">二次测量mTotalLength</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二次测量部分View和对为测量的子View进行测量"><span class="nav-number">1.3.1.5.</span> <span class="nav-text">二次测量部分View和对为测量的子View进行测量</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#delta为负的相关解析"><span class="nav-number">1.3.1.5.0.1.</span> <span class="nav-text">delta为负的相关解析</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#layout过程"><span class="nav-number">1.3.2.</span> <span class="nav-text">layout过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#draw-源码分析"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">draw 源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RelativeLayout-源码分析"><span class="nav-number">1.4.</span> <span class="nav-text">RelativeLayout  源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#measure过程-1"><span class="nav-number">1.4.1.</span> <span class="nav-text">measure过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主要过程-1"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">主要过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-将内部View根据纵向关系和横向关系排序"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">1 将内部View根据纵向关系和横向关系排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-初始化相关变量"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">2 初始化相关变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-遍历水平关系的View"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">3  遍历水平关系的View</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-遍历竖直关系的View"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">4 遍历竖直关系的View</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-baseline计算"><span class="nav-number">1.4.1.6.</span> <span class="nav-text">5 baseline计算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-宽度和高度修正"><span class="nav-number">1.4.1.7.</span> <span class="nav-text">6 宽度和高度修正</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简单总结"><span class="nav-number">1.4.1.8.</span> <span class="nav-text">简单总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RelativeLayout的layout过程"><span class="nav-number">1.4.2.</span> <span class="nav-text">RelativeLayout的layout过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RelativeLayout的draw过程"><span class="nav-number">1.4.3.</span> <span class="nav-text">RelativeLayout的draw过程</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">clwater</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Thème -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  

  


</body>
</html>
